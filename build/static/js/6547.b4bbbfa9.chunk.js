"use strict";(self.webpackChunkmedishift_deployment_server=self.webpackChunkmedishift_deployment_server||[]).push([[6547],{6547(e,t,s){s.r(t),s.d(t,{default:()=>D});var a=s(9379),r=s(2483),o=s(7958),n=s(5821),i=s(2206),l=s(627),d=s(9832),c=s(6240),u=s(800),m=s(2132),p=s(5892),f=s(2598),x=s(6723);const h=e=>{var t;let{conversation:s,isSelected:a,onClick:r}=e;const{t:n}=(0,o.Bd)(["messages"]),i=s.displayName||n("messages:placeholders.unknown"),l=(null===(t=s.lastMessage)||void 0===t?void 0:t.text)||n("messages:placeholders.noMessages"),d=(e=>{if(!e)return"";try{const t=e.toDate?e.toDate():new Date(e);return(0,m.GP)(t,"MMM d, yyyy")}catch(t){return""}})(s.lastMessageTimestamp||s.createdAt),c=(e=>{if(!e)return"";const t=e.toDate?e.toDate():new Date(e),s=new Date-t,a=Math.floor(s/6e4),r=Math.floor(s/36e5),o=Math.floor(s/864e5);return a<1?n("messages:time.now"):a<60?"".concat(a).concat(n("messages:time.minutes")):r<24?"".concat(r).concat(n("messages:time.hours")):o<7?"".concat(o).concat(n("messages:time.days")):t.toLocaleDateString(void 0,{month:"short",day:"numeric"})})(s.lastMessageTimestamp);return(0,x.jsxs)("button",{onClick:()=>r(s.id),className:(0,p.cn)("w-full flex items-center gap-4 pl-8 py-3 pr-0 transition-all text-left border-b border-border/40 last:border-b-0","hover:bg-muted/30",a?"bg-primary/5 border-l-4":"border-l-4 border-l-transparent hover:border-l-primary/30"),style:{borderLeftColor:a?"var(--primary-color)":"transparent"},children:[s.unreadCount>0&&!a&&(0,x.jsx)("div",{className:"flex items-center justify-center shrink-0",children:(0,x.jsx)("div",{className:"w-5 h-5 bg-destructive rounded-full flex items-center justify-center text-xs font-bold text-white",children:s.unreadCount>9?"9+":s.unreadCount})}),(!s.unreadCount||a)&&(0,x.jsx)("div",{className:"w-5 shrink-0"}),(0,x.jsx)("div",{className:(0,p.cn)("w-12 h-12 rounded-xl flex items-center justify-center shrink-0 transition-colors overflow-hidden",a?"bg-primary/10":"bg-muted/30"),children:s.photoURL?(0,x.jsx)("img",{src:s.photoURL,alt:i,className:"w-full h-full object-cover"}):(0,x.jsx)(f.mEP,{className:"w-6 h-6",style:{color:a?"var(--primary-color)":"var(--text-light-color)"}})}),(0,x.jsxs)("div",{className:"flex-1 min-w-0 flex flex-col gap-1.5",children:[(0,x.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,x.jsx)("h3",{className:(0,p.cn)("text-sm font-semibold truncate flex-1",(s.unreadCount,"")),style:{color:"var(--text-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:i}),c&&(0,x.jsx)("span",{className:"text-xs shrink-0",style:{color:"var(--text-light-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:c})]}),l&&(0,x.jsx)("p",{className:"text-xs truncate",style:{color:"var(--text-light-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:l}),d&&(0,x.jsx)("p",{className:"text-xs",style:{color:"var(--text-light-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:d})]}),(0,x.jsx)(f.fOo,{className:(0,p.cn)("w-5 h-5 shrink-0 transition-colors",a?"":"opacity-0"),style:{color:"var(--text-light-color)"}})]})},g=e=>{let{conversations:t,selectedConversationId:s,onSelectConversation:a,messageContext:r,currentUserId:n}=e;const{t:i}=(0,o.Bd)(["messages"]);return t.length?(0,x.jsx)("div",{className:"flex flex-col gap-0",children:t.map(e=>(0,x.jsx)(h,{conversation:e,isSelected:s===e.id,onClick:a},e.id))}):(0,x.jsx)("div",{className:"flex flex-col items-center justify-center h-full text-center",style:{color:"var(--text-light-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)"},children:(0,x.jsx)("p",{style:{margin:0},children:i("messages:empty.noConversationsFound")})})};var v=s(6935);const y=e=>{let{conversation:t,currentUser:s,messageContext:l="personal",workspaceContext:d,isTutorial:c=!1}=e;const{t:u}=(0,o.Bd)(["messages"]),{showError:m}=(0,v.h)(),[h,g]=(0,r.useState)([]),[y,b]=(0,r.useState)(""),[w,N]=(0,r.useState)(!0),[j,k]=(0,r.useState)(!1),[C,D]=(0,r.useState)(!1),I=(0,r.useRef)(null),M=(0,r.useRef)(null),T=()=>{I.current&&(I.current.scrollTop=I.current.scrollHeight)};(0,r.useEffect)(()=>{T()},[h]);const A=(0,r.useCallback)(()=>{if(!c||!t)return[];const e=new Date,a=[];if("tutorial-doctor-smith"===t.id){const t="tutorial-doctor",r=u("messages:tutorial.doctorName");a.push({id:"mock-1",senderId:t,senderName:r,text:u("messages:tutorial.doctorMessage1","Hello! I wanted to discuss the temporary contract opportunity for February. Are you available for a quick call?"),timestamp:{toDate:()=>new Date(e.getTime()-72e5)},status:"read",reactions:[]},{id:"mock-2",senderId:(null===s||void 0===s?void 0:s.uid)||"current-user",senderName:(null===s||void 0===s?void 0:s.displayName)||u("messages:status.you"),text:u("messages:tutorial.doctorMessage2","Yes, I'm very interested! When would be a good time for you?"),timestamp:{toDate:()=>new Date(e.getTime()-54e5)},status:"read",reactions:[]},{id:"mock-3",senderId:t,senderName:r,text:u("messages:tutorial.doctorMessage3","Great! How about tomorrow at 2 PM? I can share more details about the position and answer any questions you might have."),timestamp:{toDate:()=>new Date(e.getTime()-36e5)},status:"read",reactions:[]})}else if("tutorial-lausanne-clinic"===t.id){const t="tutorial-hospital",r=u("messages:tutorial.hospitalName");a.push({id:"mock-4",senderId:t,senderName:r,text:u("messages:tutorial.hospitalMessage1","Your application has been reviewed and we're impressed with your qualifications. We'd like to schedule an interview."),timestamp:{toDate:()=>new Date(e.getTime()-864e5)},status:"read",reactions:[]},{id:"mock-5",senderId:(null===s||void 0===s?void 0:s.uid)||"current-user",senderName:(null===s||void 0===s?void 0:s.displayName)||u("messages:status.you"),text:u("messages:tutorial.hospitalMessage2","Thank you so much! I'm very excited about this opportunity. I'm available next week."),timestamp:{toDate:()=>new Date(e.getTime()-828e5)},status:"read",reactions:[]},{id:"mock-6",senderId:t,senderName:r,text:u("messages:tutorial.hospitalMessage3","Perfect! I'll send you a calendar invite with available time slots. Looking forward to speaking with you."),timestamp:{toDate:()=>new Date(e.getTime()-792e5)},status:"read",reactions:[]})}return a.sort((e,t)=>e.timestamp.toDate()-t.timestamp.toDate())},[c,t,s,u]);(0,r.useEffect)(()=>{if(c){const e=A();return g(e),void N(!1)}if(!t||!s)return g([]),void N(!1);N(!0);const e=(0,n.P)((0,n.rJ)(i.db,"conversations",t.id,"messages"),(0,n.My)("timestamp","asc"));return M.current&&M.current(),M.current=(0,n.aQ)(e,e=>{const t=e.docs.map(e=>(0,a.A)({id:e.id},e.data()));g(t),N(!1)},e=>{console.error("Error fetching messages:",e),m("Failed to load messages"),N(!1)}),()=>{M.current&&M.current()}},[t,s,m,c,A]);const E=async e=>{if(e.preventDefault(),y.trim()&&!j){if(c){const e={id:"mock-".concat(Date.now()),senderId:(null===s||void 0===s?void 0:s.uid)||"current-user",senderName:(null===s||void 0===s?void 0:s.displayName)||u("messages:status.you"),text:y.trim(),timestamp:{toDate:()=>new Date},status:"sent",reactions:[]};return g(t=>[...t,e]),b(""),void setTimeout(T,100)}k(!0);try{const e={senderId:s.uid,text:y.trim(),timestamp:(0,n.serverTimestamp)(),status:"sent",reactions:[]};await(0,n.gS)((0,n.rJ)(i.db,"conversations",t.id,"messages"),e),b(""),setTimeout(T,100)}catch(a){console.error("Error sending message:",a),m("Failed to send message")}finally{k(!1)}}};return w?(0,x.jsx)("div",{className:"h-full flex items-center justify-center bg-background/50",children:(0,x.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,x.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-2 border-primary border-t-transparent"}),(0,x.jsx)("span",{className:"text-sm text-muted-foreground",children:u("messages:loading")})]})}):(0,x.jsxs)("div",{className:"h-full flex flex-col bg-background",children:[(0,x.jsxs)("div",{className:"shrink-0 flex items-center justify-between px-6 py-4 border-b border-border bg-card/95 backdrop-blur-sm min-h-16",children:[(0,x.jsx)("div",{className:"flex items-center justify-center shrink-0 mr-3",children:(0,x.jsx)("div",{className:"w-2 h-2 rounded-full bg-green-500 animate-pulse"})}),(0,x.jsxs)("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[t.photoURL&&(0,x.jsx)("button",{onClick:()=>D(!0),className:"shrink-0 w-10 h-10 rounded-full overflow-hidden border-2 border-border hover:border-primary/50 transition-colors cursor-pointer",children:(0,x.jsx)("img",{src:t.photoURL,alt:t.displayName||u("messages:status.unknownUser"),className:"w-full h-full object-cover"})}),!t.photoURL&&(0,x.jsx)("div",{className:"shrink-0 w-10 h-10 rounded-full bg-primary/10 border-2 border-primary/20 flex items-center justify-center",children:(0,x.jsx)(f.JXP,{className:"w-5 h-5 text-primary"})}),(0,x.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,x.jsxs)("h3",{className:"text-sm font-semibold text-foreground truncate flex items-center gap-2",style:{fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:[t.displayName||u("messages:status.unknownUser"),"facility"===l&&(0,x.jsx)("span",{className:"px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-primary/10 text-primary border border-primary/20 dark:bg-primary/30 dark:text-primary-foreground dark:border-primary/50",children:u("messages:context.facilityLabel")})]}),(0,x.jsx)("p",{className:"text-xs text-muted-foreground truncate",style:{fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:"facility"===l?"".concat(u("messages:context.facility")," ").concat(t.contractId?"\u2022 ".concat(u("messages:context.contract")):""):u("messages:context.personal")})]})]})]}),C&&t.photoURL&&(0,x.jsx)("div",{className:"fixed inset-0 z-50 bg-black/30 flex items-center justify-center transition-opacity duration-300",onClick:()=>D(!1),children:(0,x.jsxs)("div",{className:"relative flex items-center justify-center p-8",onClick:e=>e.stopPropagation(),children:[(0,x.jsx)("button",{onClick:()=>D(!1),className:"absolute -top-2 -right-2 z-10 h-8 w-8 flex items-center justify-center bg-background/90 hover:bg-background border border-border rounded-full transition-colors shadow-lg",children:(0,x.jsx)(f.yGN,{className:"h-4 w-4",style:{color:"var(--text-color)"}})}),(0,x.jsx)("div",{className:"relative flex items-center justify-center",children:(0,x.jsx)("img",{src:t.photoURL,alt:t.displayName||"User",className:"w-48 h-48 object-cover rounded-full border-4 border-background shadow-xl"})})]})}),(0,x.jsx)("style",{children:"\n        @keyframes textAppear {\n          from {\n            opacity: 0;\n            transform: translateY(4px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n        .message-text-animate {\n          animation: textAppear 0.4s ease-out forwards;\n          opacity: 0;\n        }\n        .message-bubble-animate {\n          animation: textAppear 0.3s ease-out forwards;\n          opacity: 0;\n        }\n      "}),(0,x.jsx)("div",{ref:I,className:"flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar bg-muted/10",style:{scrollbarGutter:"stable"},children:(0,x.jsx)("div",{className:"w-full px-6 py-6",children:0===h.length?(0,x.jsxs)("div",{className:"h-full min-h-[400px] flex flex-col items-center justify-center text-center",children:[(0,x.jsx)("div",{className:"w-16 h-16 rounded-2xl bg-primary/10 flex items-center justify-center mb-4",children:(0,x.jsx)(f.kGk,{className:"w-8 h-8 text-primary/60"})}),(0,x.jsx)("h4",{className:"text-base font-semibold text-foreground mb-2",style:{margin:0},children:u("messages:empty.noMessagesInChat")}),(0,x.jsx)("p",{className:"text-sm text-muted-foreground max-w-xs",style:{margin:0},children:u("messages:empty.startChatting")})]}):(0,x.jsx)("div",{className:"space-y-6",children:h.map((e,a)=>{var o,n,i;const l=e.senderId===((null===s||void 0===s?void 0:s.uid)||"current-user"),d=0===a||new Date(null===(o=e.timestamp)||void 0===o?void 0:o.toDate()).toDateString()!==new Date(null===(n=h[a-1].timestamp)||void 0===n?void 0:n.toDate()).toDateString(),c=a>0&&h[a-1].senderId===e.senderId;return(0,x.jsxs)(r.Fragment,{children:[d&&e.timestamp&&(0,x.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,x.jsx)("div",{className:"px-3 py-1 rounded-full bg-muted/60 text-xs font-medium text-muted-foreground",children:new Date(e.timestamp.toDate()).toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"})})}),(0,x.jsxs)("div",{className:(0,p.cn)("flex gap-3 items-end w-full",l?"justify-end":"justify-start",!c&&"mt-4"),children:[!l&&(0,x.jsx)("div",{className:(0,p.cn)("shrink-0 w-8 h-8 rounded-full bg-muted/30 flex items-center justify-center",c&&"opacity-0"),children:(0,x.jsx)(f.JXP,{className:"w-4 h-4 text-muted-foreground"})}),(0,x.jsxs)("div",{className:(0,p.cn)("flex flex-col gap-1.5 max-w-[70%] message-bubble-animate",l?"items-end":"items-start"),style:{animationDelay:"".concat(.05*a,"s")},children:[!l&&!c&&(0,x.jsx)("span",{className:"text-xs font-medium text-muted-foreground px-1",children:e.senderName||t.displayName||u("messages:status.unknownUser")}),(0,x.jsx)("div",{className:(0,p.cn)("px-4 py-3 rounded-2xl shadow-sm",l?"bg-primary text-primary-foreground rounded-br-sm":"bg-muted/50 text-foreground border border-border/50 rounded-bl-sm"),children:(0,x.jsx)("p",{className:(0,p.cn)("text-sm leading-relaxed whitespace-pre-wrap break-words message-text-animate",l?"text-primary-foreground":"text-foreground"),style:{margin:0,animationDelay:"".concat(.05*a+.1,"s")},children:e.text})}),(0,x.jsx)("span",{className:(0,p.cn)("text-xs text-muted-foreground px-1",l?"text-right":"text-left"),children:null!==(i=e.timestamp)&&void 0!==i&&i.toDate?new Date(e.timestamp.toDate()).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"}):u("messages:status.sending")})]}),l&&(0,x.jsx)("div",{className:(0,p.cn)("shrink-0 w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center",c&&"opacity-0"),children:(0,x.jsx)(f.JXP,{className:"w-4 h-4 text-primary"})})]})]},e.id)})})})}),(0,x.jsxs)("div",{className:"shrink-0 px-4 py-3 border-t border-border bg-card/95 backdrop-blur-sm",children:[(0,x.jsx)("style",{children:"\n          .message-textarea::-webkit-scrollbar {\n            display: none;\n          }\n          .message-textarea {\n            -ms-overflow-style: none;\n            scrollbar-width: none;\n          }\n        "}),(0,x.jsx)("form",{onSubmit:E,className:"w-full",children:(0,x.jsxs)("div",{className:"flex items-start gap-2",children:[(0,x.jsx)("div",{className:"flex-1 relative",children:(0,x.jsx)("textarea",{value:y,onChange:e=>b(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),E(e))},placeholder:u("messages:placeholders.typeMessage"),rows:1,className:"message-textarea w-full resize-none px-3 py-2 rounded-lg border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring transition-all overflow-y-auto",disabled:j,style:{height:"36px",minHeight:"36px",maxHeight:"120px",fontFamily:"var(--font-family-text, Roboto, sans-serif)",lineHeight:"1.5",margin:0},onInput:e=>{e.target.style.height="auto",e.target.style.height=Math.min(e.target.scrollHeight,120)+"px",e.target.scrollHeight<=36&&(e.target.style.height="36px")}})}),(0,x.jsx)("button",{type:"submit",disabled:!y.trim()||j,className:(0,p.cn)("shrink-0 w-9 h-9 flex items-center justify-center rounded-lg transition-all","bg-primary text-primary-foreground shadow-sm hover:shadow-md","disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none","hover:scale-105 active:scale-95"),title:u("messages:conversation.sendMessage"),style:{margin:0,marginTop:"2px"},children:j?(0,x.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):(0,x.jsx)(f.kGk,{className:"w-4 h-4"})})]})})]})]})};var b=s(9389),w=s(7677);const N={getConversations:async()=>{try{const s=i.auth.currentUser;if(!s)throw new Error("No authenticated user");const r=(0,n.rJ)(i.db,"conversations"),o=(0,n.P)(r,(0,n._M)("participantIds","array-contains",s.uid),(0,n.My)("lastMessageTimestamp","desc")),l=await(0,n.GG)(o),d=[];for(const c of l.docs){var e,t;const r=c.data();let o=[];if(r.participantInfo&&Array.isArray(r.participantInfo))o=r.participantInfo.filter(e=>e.userId!==s.uid);else{const e=r.participantIds||r.participants||[];for(const t of e)if(t!==s.uid){const e=(0,n.doc)(i.db,"users",t),s=await(0,n.getDoc)(e);s.exists()&&o.push({userId:s.id,displayName:s.data().displayName||"Unknown User",photoURL:s.data().photoURL})}}d.push((0,a.A)((0,a.A)({id:c.id},r),{},{participantInfo:r.participantInfo||o,lastUpdated:(null===(e=r.lastMessageTimestamp)||void 0===e?void 0:e.toDate())||(null===(t=r.updatedAt)||void 0===t?void 0:t.toDate())||new Date}))}return d}catch(s){throw console.error("Error fetching conversations:",s),s}},getConversation:async e=>{try{const t=(0,n.doc)(i.db,"conversations",e),s=await(0,n.getDoc)(t);if(!s.exists())throw new Error("Conversation not found");return(0,a.A)({id:s.id},s.data())}catch(t){throw console.error("Error fetching conversation ".concat(e,":"),t),t}},createConversation:async e=>{try{const t=i.auth.currentUser;if(!t)throw new Error("No authenticated user");const s=e.participantIds||e.participants||[];if(!s.includes(t.uid))throw new Error("You must be a participant in the conversation");const r=[...new Set(s)],o={participantIds:r,participantInfo:e.participantInfo||[],contractId:e.contractId||null,facilityProfileId:e.facilityProfileId||null,professionalProfileId:e.professionalProfileId||null,lastMessage:{text:"",senderId:"",timestamp:(0,n.serverTimestamp)()},lastMessageTimestamp:(0,n.serverTimestamp)(),unreadCounts:r.reduce((e,t)=>(e[t]=0,e),{}),isArchivedBy:[],typingIndicator:r.reduce((e,t)=>(e[t]=!1,e),{}),createdAt:(0,n.serverTimestamp)(),updatedAt:(0,n.serverTimestamp)(),createdBy:t.uid},l=(0,n.rJ)(i.db,"conversations"),d=await(0,n.gS)(l,o),c=await(0,n.getDoc)(d);return(0,a.A)({id:d.id},c.data())}catch(t){throw console.error("Error creating conversation:",t),t}},getMessages:async e=>{try{const t=(0,n.rJ)(i.db,"conversations",e,"messages"),s=(0,n.P)(t,(0,n.My)("timestamp","asc")),r=await(0,n.GG)(s),o=[];return r.forEach(e=>{var t;const s=e.data();o.push((0,a.A)((0,a.A)({id:e.id},s),{},{timestamp:(null===(t=s.timestamp)||void 0===t?void 0:t.toDate())||new Date}))}),o}catch(t){throw console.error("Error fetching messages for conversation ".concat(e,":"),t),t}},sendMessage:async(e,t)=>{try{var s,r;const o=i.auth.currentUser;if(!o)throw new Error("No authenticated user");const l=(0,n.doc)(i.db,"conversations",e),d=await(0,n.getDoc)(l);if(!d.exists())throw new Error("Conversation not found");const c=d.data();if(!((null===(s=c.participantIds)||void 0===s?void 0:s.includes(o.uid))||(null===(r=c.participants)||void 0===r?void 0:r.includes(o.uid))))throw new Error("Not authorized to send message to this conversation");const u=(0,n.rJ)(i.db,"conversations",e,"messages"),m=n.Timestamp.now(),p=await(0,n.gS)(u,(0,a.A)((0,a.A)({},t),{},{senderId:o.uid,timestamp:m,read:!1})),f=c.participantIds||c.participants||[],x={lastMessage:{text:t.text,senderId:o.uid,timestamp:m},lastMessageTimestamp:m,updatedAt:(0,n.serverTimestamp)()};if(c.unreadCounts){const e=(0,a.A)({},c.unreadCounts);f.forEach(t=>{t!==o.uid&&(e[t]=(e[t]||0)+1)}),x.unreadCounts=e}else x.unreadBy=(0,n.arrayUnion)(...f.filter(e=>e!==o.uid));await(0,n.updateDoc)(l,x);const h=await(0,n.getDoc)(p);return(0,a.A)((0,a.A)({id:p.id},h.data()),{},{timestamp:h.data().timestamp.toDate()})}catch(o){throw console.error("Error sending message in conversation ".concat(e,":"),o),o}},markAsRead:async e=>{try{var t,s;const r=i.auth.currentUser;if(!r)throw new Error("No authenticated user");const o=(0,n.doc)(i.db,"conversations",e),l=await(0,n.getDoc)(o);if(!l.exists())throw new Error("Conversation not found");const d=l.data();if(!((null===(t=d.participantIds)||void 0===t?void 0:t.includes(r.uid))||(null===(s=d.participants)||void 0===s?void 0:s.includes(r.uid))))throw new Error("Not authorized to access this conversation");if(d.unreadCounts){const e=(0,a.A)({},d.unreadCounts);e[r.uid]=0,await(0,n.updateDoc)(o,{unreadCounts:e})}else if(d.unreadBy){const e=(d.unreadBy||[]).filter(e=>e!==r.uid);await(0,n.updateDoc)(o,{unreadBy:e})}return{success:!0}}catch(r){throw console.error("Error marking conversation ".concat(e," as read:"),r),r}}};var j=s(4506);const k="personal",C="facility",D=()=>{const{t:e}=(0,o.Bd)(["messages"]),{showError:t}=(0,v.h)(),{user:s,selectedWorkspace:m}=(0,l.M)(),h=(0,d.n)(),D=(0,c.K)(),I=(0,r.useRef)((null===D||void 0===D?void 0:D.setPageMobileState)||(()=>{})),{isTutorialActive:M,activeTutorial:T}=(0,j.s8)(),[A,E]=(0,r.useState)([]),[S,R]=(0,r.useState)(null),[U,L]=(0,r.useState)(!0),[P,F]=(0,r.useState)(null),[Y,G]=(0,r.useState)(""),[z,B]=(0,r.useState)(!1),[J,H]=(0,r.useState)(""),[K,_]=(0,r.useState)(!0),[W,q]=(0,r.useState)(!1),[O,X]=(0,r.useState)(new Set),Q=(0,r.useRef)(null),V=(0,r.useMemo)(()=>m&&s?m.type===u.KY.PERSONAL?"personal":m.type===u.KY.TEAM?m.role||"employee":null:null,[m,s]),Z=(0,r.useMemo)(()=>{if(!m||m.type!==u.KY.TEAM)return!1;return V&&"employee"!==V},[m,V]);(0,r.useEffect)(()=>{if(!s||!m)return E([]),void L(!1);return(async()=>{L(!0),F(null);try{let r;const o=(0,n.rJ)(i.db,"conversations"),l=k;if(l===k)r=(0,n.P)(o,(0,n._M)("participantIds","array-contains",s.uid),(0,n.My)("lastMessageTimestamp","desc"));else{if(l!==C||!Z)return E([]),void L(!1);r=(0,n.P)(o,(0,n._M)("facilityProfileId","==",m.facilityId),(0,n.My)("lastMessageTimestamp","desc"))}Q.current&&Q.current(),Q.current=(0,n.aQ)(r,async e=>{const t=[];e.docs.forEach(e=>{const r=e.data();let o={};const n=k;if(n===k){var i;const e=null===(i=r.participantInfo)||void 0===i?void 0:i.find(e=>e.userId!==s.uid);e&&(o={displayName:e.displayName,photoURL:e.photoURL,role:e.roleInConversation,otherParticipant:e})}else if(n===C){var l;const e=null===(l=r.participantInfo)||void 0===l?void 0:l.find(e=>"professional"===e.roleInConversation);o=e?{displayName:"".concat(e.displayName," (Professional)"),photoURL:e.photoURL,role:"professional",contractId:r.contractId}:{displayName:"Facility Conversation",photoURL:null,role:"facility",contractId:r.contractId}}t.push((0,a.A)((0,a.A)({id:e.id},r),o))}),t.sort((e,t)=>{var s,a,r,o;const n=(null===(s=e.lastMessageTimestamp)||void 0===s||null===(a=s.toDate)||void 0===a?void 0:a.call(s))||new Date(0);return((null===(r=t.lastMessageTimestamp)||void 0===r||null===(o=r.toDate)||void 0===o?void 0:o.call(r))||new Date(0))-n}),E(t),L(!1)},s=>{console.error("Error listening to conversations:",s),F(s),t(e("errors.loadingConversations","Failed to load conversations")),L(!1)})}catch(r){console.error("Error setting up conversations listener:",r),F(r),t(e("errors.loadingConversations","Failed to load conversations")),L(!1)}})(),()=>{Q.current&&Q.current()}},[s,m,Z,e,t]),(0,r.useEffect)(()=>{const e=I.current;if(e&&"function"===typeof e)if(h){e(!!S,()=>{R(null),_(!0)})}else e(!1,null)},[h,S]);const $=(0,r.useCallback)(()=>{if(!M||"messages"!==T)return[];const t=new Date,a=new Date(t.getTime()-72e5),r=new Date(t.getTime()-864e5);return[{id:"tutorial-doctor-smith",displayName:e("messages:tutorial.doctorName"),photoURL:null,lastMessage:{text:e("messages:tutorial.doctorMessage")},lastMessageTimestamp:{toDate:()=>a},createdAt:{toDate:()=>new Date(t.getTime()-6048e5)},unreadCount:1,participantIds:[(null===s||void 0===s?void 0:s.uid)||"current-user","tutorial-doctor"],participantInfo:[{userId:(null===s||void 0===s?void 0:s.uid)||"current-user",displayName:(null===s||void 0===s?void 0:s.displayName)||"You",roleInConversation:"professional"},{userId:"tutorial-doctor",displayName:e("messages:tutorial.doctorName"),roleInConversation:"professional"}],isTutorial:!0},{id:"tutorial-lausanne-clinic",displayName:e("messages:tutorial.hospitalName"),photoURL:null,lastMessage:{text:e("messages:tutorial.hospitalMessage")},lastMessageTimestamp:{toDate:()=>r},createdAt:{toDate:()=>new Date(t.getTime()-12096e5)},unreadCount:0,participantIds:[(null===s||void 0===s?void 0:s.uid)||"current-user","tutorial-hospital"],participantInfo:[{userId:(null===s||void 0===s?void 0:s.uid)||"current-user",displayName:(null===s||void 0===s?void 0:s.displayName)||"You",roleInConversation:"professional"},{userId:"tutorial-hospital",displayName:e("messages:tutorial.hospitalName"),roleInConversation:"facility"}],isTutorial:!0}]},[M,T,s,e]);(0,r.useEffect)(()=>{if(null!==S&&void 0!==S&&S.isTutorial){if(!M||"messages"!==T)return R(null),void(h&&_(!0));$().some(e=>e.id===S.id)||(R(null),h&&_(!0))}},[M,T,S,h,$]);const ee=(0,r.useCallback)(e=>{let t=[...e];if(Y){const e=Y.toLowerCase();t=t.filter(t=>{var s,a,r;return(null===(s=t.displayName)||void 0===s?void 0:s.toLowerCase().includes(e))||(null===(a=t.lastMessage)||void 0===a||null===(r=a.text)||void 0===r?void 0:r.toLowerCase().includes(e))})}if(z&&(t=t.filter(e=>e.unreadCount>0)),J){const e=new Date;let s=new Date;switch(J){case"last-week":s.setDate(e.getDate()-7);break;case"last-month":s.setMonth(e.getMonth()-1);break;case"last-3-months":s.setMonth(e.getMonth()-3);break;case"last-year":s.setFullYear(e.getFullYear()-1);break;default:s=new Date(0)}t=t.filter(e=>{var t,a;return((null===(t=e.lastMessageTimestamp)||void 0===t||null===(a=t.toDate)||void 0===a?void 0:a.call(t))||new Date(0))>=s})}return t},[Y,z,J]),te=(0,r.useMemo)(()=>{const e=$();return(e.length>0&&0===A.length?e:A).map(e=>O.has(e.id)?(0,a.A)((0,a.A)({},e),{},{unreadCount:0}):e)},[A,$,O]),se=(0,r.useMemo)(()=>ee(te),[te,ee]),ae=(0,r.useCallback)(async e=>{const t=te.find(t=>t.id===e);if(t&&(R(t),X(t=>new Set([...t,e])),h&&_(!1),s&&!t.isTutorial))try{await N.markAsRead(e)}catch(P){console.error("Error marking conversation as read:",P)}},[te,s,h]),re=(0,r.useMemo)(()=>se.filter(e=>e.unreadCount>0).length,[se]);return!U||0!==A.length||M&&"messages"===T?P?(0,x.jsx)(w.A,{title:e("errors.title"),description:e("errors.description"),actionText:e("errors.retry"),onAction:()=>window.location.reload()}):(0,x.jsxs)("div",{className:(0,p.cn)("h-full flex flex-col overflow-hidden animate-in fade-in duration-500",h&&"overflow-y-hidden"),children:[(0,x.jsx)("div",{className:(0,p.cn)("shrink-0 w-full z-20 bg-card/95 backdrop-blur-sm border-b border-border shadow-sm h-16",h?"px-4":"px-6"),children:h?(0,x.jsx)("div",{className:"flex items-center gap-2 h-full",children:(0,x.jsxs)("div",{className:"flex-1 relative",children:[(0,x.jsx)(f.CKj,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none"}),(0,x.jsx)("input",{type:"text",placeholder:e("messages:searchPlaceholder"),value:Y,onChange:e=>G(e.target.value),className:"w-full h-9 pl-9 pr-20 rounded-lg border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring transition-all"}),(0,x.jsxs)("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1",children:[Y&&(0,x.jsx)("button",{onClick:()=>G(""),className:"p-1.5 hover:bg-muted rounded-full transition-colors",children:(0,x.jsx)(f.yGN,{className:"w-4 h-4 text-muted-foreground"})}),(0,x.jsx)("button",{onClick:()=>q(!0),className:(0,p.cn)("p-1.5 rounded-full transition-colors relative",z||J?"bg-primary/10 text-primary":"hover:bg-muted text-muted-foreground"),children:(0,x.jsx)(f.ou6,{className:"w-4 h-4"})})]})]})}):(0,x.jsxs)("div",{className:"flex items-center gap-3 h-full",children:[(0,x.jsxs)("div",{className:"flex-1 flex items-center gap-3",children:[(0,x.jsxs)("div",{className:"flex-1 relative",children:[(0,x.jsx)(f.CKj,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none"}),(0,x.jsx)("input",{type:"text",placeholder:e("messages:searchPlaceholder"),value:Y,onChange:e=>G(e.target.value),className:"w-full h-9 pl-9 pr-8 rounded-lg border border-input bg-background text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring transition-all"}),Y&&(0,x.jsx)("button",{onClick:()=>G(""),className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 hover:bg-muted rounded-full transition-colors",children:(0,x.jsx)(f.yGN,{className:"w-3.5 h-3.5 text-muted-foreground"})})]}),(0,x.jsxs)("select",{value:z?"unread":"all",onChange:e=>B("unread"===e.target.value),className:"h-9 px-3 rounded-lg border border-input bg-background text-xs font-medium focus:outline-none focus:ring-2 focus:ring-ring transition-all shrink-0 min-w-[120px]",children:[(0,x.jsx)("option",{value:"all",children:e("messages:filters.all")}),(0,x.jsx)("option",{value:"unread",children:e("messages:filters.unreadOnly")})]}),(0,x.jsxs)("select",{value:J,onChange:e=>H(e.target.value),className:"h-9 px-3 rounded-lg border border-input bg-background text-xs font-medium focus:outline-none focus:ring-2 focus:ring-ring transition-all shrink-0 min-w-[120px]",children:[(0,x.jsx)("option",{value:"",children:e("messages:filters.date.all")}),(0,x.jsx)("option",{value:"last-week",children:e("messages:filters.date.lastWeek")}),(0,x.jsx)("option",{value:"last-month",children:e("messages:filters.date.lastMonth")}),(0,x.jsx)("option",{value:"last-3-months",children:e("messages:filters.date.last3Months")}),(0,x.jsx)("option",{value:"last-year",children:e("messages:filters.date.lastYear")})]})]}),re>0&&(0,x.jsxs)("div",{className:"shrink-0 flex items-center gap-2 px-3 py-1.5 bg-destructive/10 rounded-lg border border-destructive/20",children:[(0,x.jsx)("span",{className:"text-xs font-medium text-muted-foreground m-0",children:e("messages:unread")}),(0,x.jsx)("span",{className:"text-sm font-bold text-destructive m-0",children:re})]})]})}),(0,x.jsxs)("div",{className:(0,p.cn)("flex-1 flex overflow-hidden min-h-0 relative",h?"p-0":"p-4 gap-4"),children:[(0,x.jsx)("div",{className:(0,p.cn)("flex flex-col transition-all duration-300 shrink-0",h?(0,p.cn)("absolute inset-0 z-10 bg-background overflow-y-auto",K?"translate-x-0":"-translate-x-full"):"w-full md:w-[320px] lg:w-[360px] pr-0 overflow-hidden"),children:(0,x.jsx)("div",{className:(0,p.cn)("flex-1 flex flex-col bg-card/60 backdrop-blur-sm border border-border shadow-sm overflow-hidden",h?"rounded-none border-0":"rounded-xl"),children:0===se.length?(0,x.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center gap-4 text-center",children:[(0,x.jsx)("div",{className:"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center",children:(0,x.jsx)(f.mEP,{className:"w-8 h-8",style:{color:"var(--primary-color)"}})}),(0,x.jsx)("p",{className:"text-sm font-medium",style:{color:"var(--text-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:e(Y||z||J?"messages:empty.noMessagesFound":"messages:empty.noConversationsYet")}),(0,x.jsx)("p",{className:"text-xs",style:{color:"var(--text-light-color)",fontFamily:"var(--font-family-text, Roboto, sans-serif)",margin:0},children:e(Y||z||J?"messages:empty.adjustFilters":"messages:empty.startConversation")})]}):(0,x.jsx)("div",{className:"flex-1 overflow-y-auto",style:{scrollbarGutter:"stable"},children:(0,x.jsx)(g,{conversations:se,selectedConversationId:null===S||void 0===S?void 0:S.id,onSelectConversation:ae,messageContext:k,currentUserId:null===s||void 0===s?void 0:s.uid})})})}),(0,x.jsx)("div",{className:(0,p.cn)("flex-1 flex flex-col bg-transparent relative min-w-0 min-h-0 transition-transform duration-300",h&&S?"translate-x-0 overflow-y-auto absolute inset-0 z-20":"overflow-y-auto"),children:S?(0,x.jsx)("div",{className:(0,p.cn)("h-full w-full bg-card/60 backdrop-blur-sm border border-border shadow-sm overflow-hidden",h?"rounded-none border-0":"rounded-xl"),children:(0,x.jsx)(y,{conversation:S,currentUser:s,messageContext:k,workspaceContext:m,isTutorial:null===S||void 0===S?void 0:S.isTutorial})}):(0,x.jsx)("div",{className:"w-full flex flex-col items-center justify-center p-8 text-center z-0 min-h-[400px]",children:(0,x.jsxs)("div",{className:"max-w-md w-full bg-card p-8 rounded-2xl border border-border/50 shadow-lg backdrop-blur-sm animate-in fade-in zoom-in-95 duration-500 mx-auto",children:[(0,x.jsx)("div",{className:"w-16 h-16 mx-auto rounded-full bg-muted/50 flex items-center justify-center mb-6 ring-4 ring-background",children:(0,x.jsx)(f.mEP,{className:"text-muted-foreground w-8 h-8"})}),(0,x.jsx)("h2",{className:"text-xl font-bold text-foreground mb-2",children:e("messages:selectConversation.title")}),(0,x.jsx)("p",{className:"text-muted-foreground mb-6",children:e("messages:selectConversation.subtitle")})]})})})]})]}):(0,x.jsx)(b.A,{})}},7677(e,t,s){s.d(t,{A:()=>r});s(2483);var a=s(6723);const r=e=>{let{title:t,description:s,actionText:r,onAction:o,icon:n}=e;return(0,a.jsxs)("div",{className:"empty-state",children:[n&&(0,a.jsx)("div",{className:"empty-state-icon",children:n}),(0,a.jsx)("h3",{className:"empty-state-title",children:t}),s&&(0,a.jsx)("p",{className:"empty-state-description",children:s}),r&&o&&(0,a.jsx)("button",{className:"empty-state-action",onClick:o,children:r})]})}},9832(e,t,s){s.d(t,{n:()=>r});var a=s(2483);const r=()=>{const[e,t]=(0,a.useState)(()=>"undefined"!==typeof window&&window.innerWidth<768);return(0,a.useEffect)(()=>{const e=()=>{t(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e}}}]);
//# sourceMappingURL=6547.b4bbbfa9.chunk.js.map