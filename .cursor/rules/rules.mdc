---
description: Interimed codebase conventions
globs: 
alwaysApply: true
---
Your overall approach MUST emulate the design philosophy of Claude.

## STYLING
Always use the styling variables stored in [variables.css](mdc:src/styles/variables.css).
Use the components stored in [BoxedInputFields](mdc:src/components/BoxedInputFields/) folder: Button.js, Personnalized-InputField.js, SimpleDropdown.js, TextareaField.js, etc.

## DATABASE ARCHITECTURE (CRITICAL)

### Single Source of Truth Principle
**NEVER duplicate access control logic.** All workspace/role checks MUST use centralized utilities.

### Collections Structure
| Collection | Purpose | Document ID |
|------------|---------|-------------|
| `users` | Core identity, facility roles | Firebase Auth UID |
| `professionalProfiles` | Professional profile data | Firebase Auth UID |
| `facilityProfiles` | Facility profile data | Facility ID |
| `admins` | Admin accounts | Firebase Auth UID |

### Workspace Access Determination
**NEVER check `users.role` or `users.profileType`.** These fields are REMOVED.

```javascript
// CORRECT - Use centralized utilities
import { hasProfessionalAccess, hasFacilityAccess, hasAdminAccess } from '@/utils/workspaceAccess';

// Professional: professionalProfiles/{userId} EXISTS
const canAccessPersonal = await hasProfessionalAccess(userId);

// Facility: users.roles array contains facility_uid
const canAccessFacility = hasFacilityAccess(userData, facilityId);

// Admin: admins/{userId} EXISTS with isActive !== false
const canAccessAdmin = await hasAdminAccess(userId);
```

### Users Collection Structure
```javascript
{
  uid: string,
  email: string,
  roles: [{ facility_uid: string, roles: string[] }],  // Facility access
  // NO role, profileType, profileCompleted, tutorialPassed fields
}
```

### Profile Collections Structure
```javascript
// professionalProfiles or facilityProfiles
{
  tutorialAccessMode: 'enabled' | 'disabled' | 'loading',
  currentStepIndex: number,
  subscriptionTier: 'free' | 'basic' | 'premium' | 'enterprise',
  // ... profile data
}
```

### Facility Employees Structure
```javascript
// facilityProfiles.employees
[{ user_uid: string, roles: string[] }]
// NOT { uid, rights } - this is REMOVED
```

### Workspace Types
```javascript
import { WORKSPACE_TYPES } from '@/config/keysDatabase';
// WORKSPACE_TYPES.PERSONAL, WORKSPACE_TYPES.FACILITY, WORKSPACE_TYPES.ADMIN
// NOT WORKSPACE_TYPES.TEAM - this is REMOVED
```

## ROLE DEFINITIONS
Use centralized role definitions from [roleDefinitions.js](mdc:src/config/roleDefinitions.js):
```javascript
import { hasPermission, ROLE_DEFINITIONS } from '@/config/roleDefinitions';
if (hasPermission(userRoles, 'manage_schedules')) { ... }
```

## SUBSCRIPTION TIERS
Use centralized tier checks from [subscriptionTiers.js](mdc:src/config/subscriptionTiers.js):
```javascript
import { canAccessFeature, SUBSCRIPTION_TIERS } from '@/config/subscriptionTiers';
if (canAccessFeature(userTier, 'ORGANIZATION_TAB')) { ... }
```

## TUTORIAL SYSTEM
Reference [tutorialSystem.js](mdc:src/config/tutorialSystem.js) for all tutorial logic:
```javascript
import { TUTORIAL_IDS, isProfileTutorial, getTutorialSteps } from '@/config/tutorialSystem';
```

**Tutorial state storage:**
- Database: Only `currentStepIndex` and `tutorialAccessMode` in profile collection
- LocalStorage: Full tutorial state (transient, cleared when tutorial ends)

## LOCALIZATION (CRITICAL)
**NEVER hardcode user-facing strings.** All visible text MUST use the translation function.

### Setup
```javascript
import { useTranslation } from 'react-i18next';
const { t } = useTranslation(['namespace']);
```

For class components:
```javascript
import i18n from '../i18n';
const t = (key, defaultValue) => i18n.t(key, defaultValue);
```

### Usage Pattern
Always provide a fallback default value:
```javascript
{t('namespace:key.subkey', 'Default English text')}
```

### Namespace Mapping (from i18n.js)
| Namespace | Locale File Path |
|-----------|------------------|
| `common` | `common.json` |
| `home` | `pages/home.json` |
| `auth` | `pages/auth/auth.json` |
| `about` | `pages/about.json` |
| `facilities` | `pages/facilities.json` |
| `professionals` | `pages/professionals.json` |
| `faq` | `pages/faq.json` |
| `contact` | `pages/contact.json` |
| `blog` | `pages/blog/blog.json` |
| `support` | `pages/support.json` |
| `notFound` | `pages/notFound.json` |
| `admin` | `dashboard/admin/admin.json` |
| `organization` | `dashboard/organization/organization.json` |
| `dashboardProfile` | `dashboard/profile/profile.json` |
| `calendar` | `dashboard/calendar/calendar.json` |
| `contracts` | `dashboard/contracts/contracts.json` |
| `messages` | `dashboard/messages/messages.json` |
| `marketplace` | `dashboard/marketplace/marketplace.json` |
| `tutorial` | `config/tutorial.json` |

### File Structure Mirroring
Locale keys MUST mirror the source file structure:
- `src/pages/Auth/LoginPage.js` → Uses `auth:` namespace → Keys in `public/locales/en/pages/auth/auth.json`
- `src/dashboard/pages/admin/EmailCenter.js` → Uses `admin:` namespace → Keys in `public/locales/en/dashboard/admin/admin.json`

### Adding New Locale Keys
When adding new UI text:
1. Add the key to the appropriate JSON file under `public/locales/en/`
2. Use nested objects for related keys (e.g., `auth.ban.accountDisabled`)
3. Keep keys descriptive and hierarchical

## SERVICE TREE (For New Dashboard Services)
When creating new dashboard services, document them in `public/locales/en/service_tree/`.

### Service Action Schema
```json
{
  "actionName": {
    "location": "src/services/serviceName.js",
    "function": "functionName",
    "keywords": ["keyword1", "keyword2"],
    "description": "What this action does",
    "parameters": {
      "param1": { "type": "string", "required": true, "description": "..." }
    },
    "returns": "Return value description",
    "agentCall": {
      "service": "serviceName",
      "method": "functionName",
      "example": "import { functionName } from '@/services/serviceName';\nawait functionName(param1);"
    },
    "permissions": ["user", "admin"],
    "uiTrigger": "Button in Dashboard > Section"
  }
}
```

### Service Categories
- `calendar/actions.json` - Calendar and shift management
- `contracts/actions.json` - Contract CRUD operations
- `messages/actions.json` - Messaging system
- `profile/actions.json` - User profile management
- `payroll/actions.json` - Payroll processing
- `common/actions.json` - Storage, notifications
- `account/actions.json` - Account deletion, GDPR
- `documents/actions.json` - Document processing

## FIREBASE PATTERNS
Use the established service patterns:
- `handleFirebaseOperation()` wrapper for error handling
- Firestore queries through service layer, not directly in components
- Cloud functions via `httpsCallable(functions, 'functionName')`

### Database Constants
Always use centralized keys from [keysDatabase.js](mdc:src/config/keysDatabase.js):
```javascript
import { FIRESTORE_COLLECTIONS, WORKSPACE_TYPES, LOCALSTORAGE_KEYS } from '@/config/keysDatabase';
```

### Functions Employee Checks
```javascript
// CORRECT
const isAdmin = employeesList.some(emp => emp.user_uid === userId && emp.roles?.includes('admin'));

// WRONG - uses old structure
const isAdmin = employeesList.some(emp => emp.uid === userId && emp.rights === 'admin');
```

## KEY DOCUMENTATION
- [DATABASE_IMPLEMENTATION.md](mdc:src/config/DATABASE_IMPLEMENTATION.md) - Full database architecture
- [TUTORIAL_SYSTEM_README.md](mdc:src/config/TUTORIAL_SYSTEM_README.md) - Tutorial system details
