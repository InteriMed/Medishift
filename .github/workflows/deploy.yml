name: ðŸš€ Deploy to Production
on:
  push:
    branches: [ main ]

jobs:
  # 1. TEST (Runs first)
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install & Test
        run: |
          npm ci
          npm test

  # 2. DEPLOY (Runs only if Test passes)
  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # A. INJECT PRODUCTION CONFIG
      - name: Create Prod Config
        run: echo "export const firebaseConfig = ${{ secrets.FIREBASE_CONFIG_PROD }};" > src/firebaseConfig.js

      # B. BUILD REACT APP
      - name: Install & Build
        run: |
          npm ci
          npm run build

      # C. DEPLOY FRONTEND (GoDaddy)
      - name: ðŸ“‚ Sync files to GoDaddy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./build/ # OR ./dist/ (Check your Vite/CRA settings)
      
      # D. DEPLOY BACKEND (Firebase)
      - name: ðŸ”¥ Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions,firestore
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: "interimed-620fd" # Your Production Project ID

  # 3. HEALTH CHECK
  verify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check HTTP Status
        id: health_check
        run: |
          for i in {1..3}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://medishift.cloud)
            if [ "$STATUS" == "200" ]; then
              echo "âœ… Site is up!"
              exit 0
            fi
            echo "âš ï¸ Attempt $i failed. Retrying..."
            sleep 10
          done
          echo "âŒ Site is down!"
          exit 1

  # 4. ROLLBACK (Only if Verify fails)
  rollback:
    needs: verify
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”™ Checkout Previous Commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Revert to HEAD~1
        run: git checkout HEAD~1

      # MUST RE-BUILD THE OLD CODE BEFORE UPLOADING
      - name: Create Prod Config (Old Version)
        run: echo "export const firebaseConfig = ${{ secrets.FIREBASE_CONFIG_PROD }};" > src/firebaseConfig.js

      - name: Build Old Version
        run: |
          npm ci
          npm run build

      - name: ðŸš‘ Emergency Re-Deploy Frontend
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./build/

      - name: ðŸš‘ Emergency Re-Deploy Backend
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions,firestore
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: "interimed-620fd"

      - name: ðŸ”” Notify Discord
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.NOTIFY_WEBHOOK }}
        with:
          args: 'ðŸš¨ **CRITICAL ROLLBACK** ðŸš¨ Production failed. Reverted to previous version.'