name: Deploy with Auto-Rollback
on:
  push:
    branches: [ main ]

jobs:
  # 1. Build & Test (Same as before)
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm install && npm test

  # 2. Deploy (Same as before)
  deploy:
    needs: test-and-build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}

  # 3. Health Check
  verify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Check HTTP Status
        id: health_check
        # Retry up to 3 times with 10s delay to allow server restart/cache clear
        run: |
          for i in {1..3}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://medishift.cloud)
            if [ "$STATUS" == "200" ]; then
              echo "‚úÖ Site is up!"
              exit 0
            fi
            echo "‚ö†Ô∏è Attempt $i failed (Status: $STATUS). Retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Site is down!"
          exit 1

  # 4. üö® ROLLBACK JOB üö®
  rollback:
    needs: verify
    if: failure()  # <--- ONLY RUNS IF VERIFY FAILS
    runs-on: ubuntu-latest
    steps:
      - name: üîô Checkout Previous Commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Fetch last 2 commits so we can go back 1
          
      - name: Revert to HEAD~1
        run: git checkout HEAD~1

      - name: üöë Emergency Re-Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
      - name: Notify
        run: echo "::error::Rollback completed. The site has been reverted to the previous version."

      - name: Notify Discord of Failure
        if: always() # Runs even if the rollback itself has issues
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.NOTIFY_WEBHOOK }}
        with:
          args: 'üö® **CRITICAL ALERT** üö® Deployment to GoDaddy failed. The site has been rolled back to the previous stable version. Please check the logs. ${{ steps.health_check.outputs.url }}'
          
      - name: Create Prod Environment Config
        run: |
          echo "export const firebaseConfig = ${{ secrets.FIREBASE_CONFIG_PROD }};" > src/firebaseConfig.js
          
      - name: Build
        run: npm run build