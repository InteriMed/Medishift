rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidWorkerData(data) {
      return data.keys().hasAll(['email', 'fullName', 'accountType']) 
        && data.accountType == 'worker';
    }
    
    function isValidCompanyData(data) {
      return data.keys().hasAll(['email', 'companyName', 'accountType']) 
        && data.accountType == 'company';
    }
    
    function isValidAvailabilityData(data) {
      return data.keys().hasAll(['userId', 'from', 'to']) 
        && data.userId is string
        && data.from is string
        && data.to is string;
    }
    
    // Workers collection
    match /workers/{userId} {
      allow read: if true;  // Public profiles for workers
      allow create: if isOwner(userId) && isValidWorkerData(request.resource.data);
      allow update: if isOwner(userId) && isValidWorkerData(request.resource.data);
      allow delete: if isOwner(userId);
    }
    
    // Companies collection
    match /companies/{companyId} {
      allow read: if true;  // Public profiles for companies
      allow create: if isOwner(companyId) && isValidCompanyData(request.resource.data);
      allow update: if isOwner(companyId) && isValidCompanyData(request.resource.data);
      allow delete: if isOwner(companyId);
    }
    
    // Availability collection
    match /availability/{availabilityId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && isValidAvailabilityData(request.resource.data);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Contracts collection
    match /contracts/{contractId} {
      function isContractParty() {
        return isAuthenticated() && (
          resource.data.parties.professional.profileId == request.auth.uid ||
          resource.data.parties.employer.profileId == request.auth.uid ||
          (resource.data.participants != null && request.auth.uid in resource.data.participants) ||
          resource.data.workerID == request.auth.uid ||
          resource.data.companyID == request.auth.uid
        );
      }
      function canCreateContract() {
        return isAuthenticated() && (
          request.resource.data.parties.professional.profileId == request.auth.uid ||
          request.resource.data.parties.employer.profileId == request.auth.uid ||
          (request.resource.data.participants != null && request.auth.uid in request.resource.data.participants) ||
          request.resource.data.workerID == request.auth.uid ||
          request.resource.data.companyID == request.auth.uid
        );
      }
      allow read: if isContractParty();
      allow create: if canCreateContract();
      allow update: if isContractParty() && (
        resource.data.statusLifecycle.currentStatus == 'draft' ||
        resource.data.statusLifecycle.currentStatus == 'awaiting_dual_approval' ||
        resource.data.statusLifecycle.currentStatus == 'pending_professional_approval' ||
        resource.data.statusLifecycle.currentStatus == 'pending_facility_approval' ||
        resource.data.status == 'draft' ||
        resource.data.status == 'pending' ||
        request.resource.data.statusLifecycle.currentStatus != resource.data.statusLifecycle.currentStatus
      );
      allow delete: if false;
    }
    
    // Calendar Events collection
    match /calendar_events/{eventId} {
      function isValidCalendarEventData(data) {
        return data.keys().hasAll(['userId']) && data.userId is string && (data.startDate != null || data.from != null) && (data.endDate != null || data.to != null);
      }
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && isValidCalendarEventData(request.resource.data);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Basic user document access
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Professional profile rules
    match /professionalProfiles/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId; // Removed complex validation for MVP stability
      allow update: if request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Facility profile rules
    match /facilityProfiles/{userId} {
      allow read: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      function isConversationParticipant() {
        return isAuthenticated() && (
          (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds) ||
          (resource.data.participants != null && request.auth.uid in resource.data.participants)
        );
      }
      function canCreateConversation() {
        return isAuthenticated() && (
          (request.resource.data.participantIds != null && request.auth.uid in request.resource.data.participantIds) ||
          (request.resource.data.participants != null && request.auth.uid in request.resource.data.participants)
        );
      }
      allow read: if isConversationParticipant();
      allow create: if canCreateConversation();
      allow update: if isConversationParticipant();
      allow delete: if false;
      
      match /messages/{messageId} {
        function isMessageParticipant() {
          return isAuthenticated() && (
            (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds) ||
            (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants)
          );
        }
        allow read: if isMessageParticipant();
        allow create: if isMessageParticipant() && request.resource.data.senderId == request.auth.uid;
        allow update: if isMessageParticipant() && (
          resource.data.senderId == request.auth.uid ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'status'])
        );
        allow delete: if false;
      }
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Positions collection
    match /positions/{positionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.postedByUserId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.postedByUserId == request.auth.uid ||
        // Allow facility admins to update position status (e.g., to 'interview')
        get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admin.hasAny([request.auth.uid])
      );
      allow delete: if false;
      
      match /applications/{applicationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated();
        allow delete: if false;
      }
    }
    
    // Professional Availabilities
    match /professionalAvailabilities/{availabilityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User Settings
    match /userSettings/{userId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Client errors
    match /client_errors/{errorId} {
      allow create: if isAuthenticated();
      allow read: if false;
    }
    
    // Audit logs
    match /audit_logs/{logId} {
      allow write: if false;
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    //  ðŸ‡¨ðŸ‡­ SWISS COMPLIANCE - Phase 1 & Phase 2 Features
    // =========================================================================

    // 1. Tutorials (Fixes "[TutorialContext] Error checking tutorial status")
    match /tutorials/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // 2. Legacy Collections (Fixes "Missing permissions" if app uses old names)
    match /workers_listings/{document=**} {
      allow read, write: if isAuthenticated();
    }
    match /jobs-listing/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // 3. Payroll Requests (Phase 1 - PayrollPlus Integration)
    match /payroll_requests/{requestId} {
      // Pharmacy can create, read their own, and update status
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        resource.data.pharmacyUid == request.auth.uid ||
        resource.data.workerUid == request.auth.uid
      );
      allow update: if isAuthenticated() && resource.data.pharmacyUid == request.auth.uid;
      allow delete: if false; // Never delete - financial records
    }

    // =========================================================================
    //  ðŸ”µ PHASE 2: Organizations & Chains
    // =========================================================================

    // Helper: Check if user is organization admin
    function isOrgAdmin(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)) &&
             request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)).data.admins;
    }

    // Helper: Check if user is facility admin for a specific facility
    function isFacilityAdmin(facilityId) {
      return isAuthenticated() && (
        request.auth.uid == facilityId ||
        (exists(/databases/$(database)/documents/facilityProfiles/$(facilityId)) &&
         request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(facilityId)).data.admins) ||
        (exists(/databases/$(database)/documents/facilityProfiles/$(facilityId)) &&
         request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(facilityId)).data.chainAdmins)
      );
    }

    // 4. Organizations (Pharmacy Chains/Groups)
    match /organizations/{organizationId} {
      function isOrgMember() {
        return isAuthenticated() && (
          request.auth.uid in resource.data.admins ||
          exists(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)).data.organizationId == organizationId
        );
      }
      
      allow read: if isOrgMember();
      allow create: if isAuthenticated(); // Platform creates organizations
      allow update: if isAuthenticated() && request.auth.uid in resource.data.admins;
      allow delete: if false; // Soft delete only
    }

    // 5. Staffing Requirements (The "Perfect Week" schedules)
    match /staffing_requirements/{requirementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Will verify facility admin in function
      allow update: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
      allow delete: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
    }

    // 6. Shifts (Calendar events for staffing)
    match /shifts/{shiftId} {
      function canAccessShift() {
        return isAuthenticated() && (
          isFacilityAdmin(resource.data.facilityId) ||
          resource.data.assignedUserId == request.auth.uid ||
          // Organization-level access for chain admins
          (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
        );
      }
      
      allow read: if isAuthenticated(); // Workers can see open shifts
      allow create: if isAuthenticated(); // Verified in Cloud Function
      allow update: if canAccessShift();
      allow delete: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
    }

    // 7. Leaves (Vacation, sick leave requests)
    match /leaves/{leaveId} {
      function canAccessLeave() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isFacilityAdmin(resource.data.facilityId) ||
          (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
        );
      }
      
      allow read: if canAccessLeave();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if canAccessLeave();
      allow delete: if false; // Never delete leave records
    }

    // 8. Cross-Facility Reports (Internal Interim tracking)
    match /cross_facility_reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.requestingFacilityId == request.auth.uid ||
        resource.data.providingFacilityId == request.auth.uid ||
        (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
      );
      allow create: if isAuthenticated(); // Created by Cloud Functions
      allow update, delete: if false; // Immutable financial records
    }

    // 9. Cached Document Data (15-minute auto-fill cache)
    match /cached_document_data/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 10. Extracted Data Cache (Document processing cache)
    match /extractedDataCache/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 11. Billing Information (Facility billing details)
    // Note: This is a subcollection of facilityProfiles
    match /facilityProfiles/{facilityId}/billing/{billingId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == facilityId ||
        isFacilityAdmin(facilityId)
      );
      allow write: if isAuthenticated() && isFacilityAdmin(facilityId);
    }
  }
}