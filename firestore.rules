rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidWorkerData(data) {
      return data.keys().hasAll(['email', 'fullName', 'accountType']) 
        && data.accountType == 'worker';
    }
    
    function isValidCompanyData(data) {
      return data.keys().hasAll(['email', 'companyName', 'accountType']) 
        && data.accountType == 'company';
    }
    
    function isValidEventData(data) {
      return data.keys().hasAll(['userId', 'from', 'to']) 
        && data.userId is string
        && data.from is string
        && data.to is string;
    }
    
    function isAdmin() {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
         (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['superAdmin', 'super_admin', 'admin']) ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin')) ||
        (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isActive == true)
      );
    }
    
    function isSuperAdminUser() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['superAdmin', 'super_admin']);
    }
    
    function canReadAllProfiles() {
      return isAdmin() || isSuperAdminUser();
    }
    
    // Admins collection
    match /admins/{adminId} {
      allow read: if isAuthenticated() && (request.auth.uid == adminId || isAdmin());
      allow write: if false;
    }
    
    // Admin roles collection
    match /adminRoles/{roleId} {
      allow read: if isAuthenticated() && isAdmin();
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Workers collection
    match /workers/{userId} {
      allow read: if true;  // Public profiles for workers
      allow create: if isOwner(userId) && isValidWorkerData(request.resource.data);
      allow update: if isOwner(userId) && isValidWorkerData(request.resource.data);
      allow delete: if isOwner(userId);
    }
    
    // Companies collection
    match /companies/{companyId} {
      allow read: if true;  // Public profiles for companies
      allow create: if isOwner(companyId) && isValidCompanyData(request.resource.data);
      allow update: if isOwner(companyId) && isValidCompanyData(request.resource.data);
      allow delete: if isOwner(companyId);
    }
    
    // Employee vacancy requests collection
    match /employeeVacancyRequests/{requestId} {
      function canManageEmployeeRequest() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.facilityProfileId != null && 
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins)
        );
      }
      
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.facilityProfileId != null && 
         exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
         request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins)
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if canManageEmployeeRequest();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Time off requests collection
    match /timeOffRequests/{requestId} {
      function canManageTimeOffRequest() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.facilityProfileId != null && 
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins)
        );
      }
      
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.facilityProfileId != null && 
         exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
         (request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins ||
          request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.employees))
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if canManageTimeOffRequest();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Vacancy applications collection
    match /vacancyApplications/{applicationId} {
      function canManageApplication() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.vacancyEventId != null &&
           exists(/databases/$(database)/documents/events/$(resource.data.vacancyEventId)) &&
           get(/databases/$(database)/documents/events/$(resource.data.vacancyEventId)).data.facilityProfileId != null &&
           exists(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(resource.data.vacancyEventId)).data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(resource.data.vacancyEventId)).data.facilityProfileId)).data.admins)
        );
      }
      
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || canManageApplication()
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if canManageApplication();
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Events collection
    match /events/{eventId} {
      function canViewEvent() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.visibility == 'public' && resource.data.type == 'worker_availability' && resource.data.isValidated == true) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.owners) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.viewers) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.facilityAdmins) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.chainAdmins) ||
          (resource.data.facilityProfileId != null && 
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins) ||
          (resource.data.organizationId != null &&
           exists(/databases/$(database)/documents/organizations/$(resource.data.organizationId)) &&
           request.auth.uid in get(/databases/$(database)/documents/organizations/$(resource.data.organizationId)).data.admins)
        );
      }
      
      function canManageEvent() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.owners) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.facilityAdmins) ||
          (resource.data.permissions != null && request.auth.uid in resource.data.permissions.chainAdmins) ||
          (resource.data.facilityProfileId != null && 
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admins) ||
          (resource.data.organizationId != null &&
           exists(/databases/$(database)/documents/organizations/$(resource.data.organizationId)) &&
           request.auth.uid in get(/databases/$(database)/documents/organizations/$(resource.data.organizationId)).data.admins)
        );
      }
      
      allow read: if canViewEvent();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && isValidEventData(request.resource.data);
      allow update: if canManageEvent() && request.resource.data.userId == resource.data.userId;
      allow delete: if canManageEvent();
      
      // Applications subcollection for vacancy requests
      match /applications/{applicationId} {
        allow read: if isAuthenticated() && (
          resource.data.professionalId == request.auth.uid ||
          (exists(/databases/$(database)/documents/events/$(eventId)) &&
           get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId != null &&
           exists(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId)).data.admins)
        );
        allow create: if isAuthenticated() && request.resource.data.professionalId == request.auth.uid;
        allow update: if isAuthenticated() && (
          resource.data.professionalId == request.auth.uid ||
          (exists(/databases/$(database)/documents/events/$(eventId)) &&
           get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId != null &&
           exists(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(get(/databases/$(database)/documents/events/$(eventId)).data.facilityProfileId)).data.admins)
        );
        allow delete: if isAuthenticated() && resource.data.professionalId == request.auth.uid;
      }
    }
    
    // Contracts collection
    match /contracts/{contractId} {
      function isContractParty() {
        return isAuthenticated() && (
          (resource.data.parties != null && 
           resource.data.parties.professional != null && 
           resource.data.parties.professional.profileId == request.auth.uid) ||
          (resource.data.parties != null && 
           resource.data.parties.employer != null && 
           resource.data.parties.employer.profileId == request.auth.uid) ||
          (resource.data.participants != null && request.auth.uid in resource.data.participants) ||
          (resource.data.workerID != null && resource.data.workerID == request.auth.uid) ||
          (resource.data.companyID != null && resource.data.companyID == request.auth.uid) ||
          (resource.data.workerId != null && resource.data.workerId == request.auth.uid) ||
          (resource.data.employerId != null && resource.data.employerId == request.auth.uid) ||
          isAdmin()
        );
      }
      function canCreateContract() {
        return isAuthenticated() && (
          (request.resource.data.parties != null && 
           request.resource.data.parties.professional != null && 
           request.resource.data.parties.professional.profileId == request.auth.uid) ||
          (request.resource.data.parties != null && 
           request.resource.data.parties.employer != null && 
           request.resource.data.parties.employer.profileId == request.auth.uid) ||
          (request.resource.data.participants != null && request.auth.uid in request.resource.data.participants) ||
          (request.resource.data.workerID != null && request.resource.data.workerID == request.auth.uid) ||
          (request.resource.data.companyID != null && request.resource.data.companyID == request.auth.uid) ||
          (request.resource.data.workerId != null && request.resource.data.workerId == request.auth.uid) ||
          (request.resource.data.employerId != null && request.resource.data.employerId == request.auth.uid) ||
          isAdmin()
        );
      }
      allow read: if isContractParty();
      allow create: if canCreateContract();
      allow update: if isContractParty() && (
        (resource.data.statusLifecycle != null && resource.data.statusLifecycle.currentStatus == 'draft') ||
        (resource.data.statusLifecycle != null && resource.data.statusLifecycle.currentStatus == 'awaiting_dual_approval') ||
        (resource.data.statusLifecycle != null && resource.data.statusLifecycle.currentStatus == 'pending_professional_approval') ||
        (resource.data.statusLifecycle != null && resource.data.statusLifecycle.currentStatus == 'pending_facility_approval') ||
        (resource.data.status != null && resource.data.status == 'draft') ||
        (resource.data.status != null && resource.data.status == 'pending') ||
        (request.resource.data.statusLifecycle != null && resource.data.statusLifecycle != null && 
         request.resource.data.statusLifecycle.currentStatus != resource.data.statusLifecycle.currentStatus) ||
        isAdmin()
      );
      allow delete: if false;
    }
    
    // Calendar Events collection
    match /calendar_events/{eventId} {
      function isValidCalendarEventData(data) {
        return data.keys().hasAll(['userId']) && data.userId is string && (data.startDate != null || data.from != null) && (data.endDate != null || data.to != null);
      }
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && isValidCalendarEventData(request.resource.data);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Basic user document access
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || isAdmin();
      allow delete: if false;
    }
    
    // Professional profile rules
    match /professionalProfiles/{userId} {
      allow read: if request.auth.uid == userId || canReadAllProfiles();
      allow create: if request.auth.uid == userId || canReadAllProfiles();
      allow update: if request.auth.uid == userId || canReadAllProfiles();
      allow delete: if false;
    }
    
    // Facility profile rules
    match /facilityProfiles/{facilityId} {
      function isFacilityMember() {
        return isAuthenticated() && (
          request.auth.uid == facilityId ||
          (resource.data.admins != null && request.auth.uid in resource.data.admins) ||
          (resource.data.employees != null && resource.data.employees.size() > 0)
        );
      }
      function canReadFacility() {
        return isAuthenticated() && (
          request.auth.uid == facilityId ||
          canReadAllProfiles() ||
          (exists(/databases/$(database)/documents/facilityProfiles/$(facilityId)) == false) ||
          (resource.data.admins != null && request.auth.uid in resource.data.admins) ||
          (resource.data.chainAdmins != null && request.auth.uid in resource.data.chainAdmins)
        );
      }
      function isSuperAdmin() {
        return isAuthenticated() && (
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['superAdmin', 'super_admin'])) ||
          (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
           get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isActive == true &&
           (get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'superAdmin' ||
            get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin' ||
            (get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.roles != null &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.roles.hasAny(['superAdmin', 'super_admin']))))
        );
      }
      allow read: if canReadFacility() || isSuperAdminUser();
      allow create: if request.auth.uid == facilityId || isAdmin();
      allow update: if request.auth.uid == facilityId || isAdmin() || (resource.data.admins != null && request.auth.uid in resource.data.admins);
      allow delete: if isSuperAdmin() || isAdmin();
    }
    
    // Organization profile rules
    match /organizations/{organizationId} {
      function isOrganizationMember() {
        return isAuthenticated() && (
          request.auth.uid == organizationId ||
          (resource.data.internalTeam != null && 
           resource.data.internalTeam.admins != null && 
           request.auth.uid in resource.data.internalTeam.admins) ||
          (resource.data.internalTeam != null && 
           resource.data.internalTeam.employees != null && 
           resource.data.internalTeam.employees.size() > 0)
        );
      }
      function canReadOrganization() {
        return isAuthenticated() && (
          request.auth.uid == organizationId ||
          canReadAllProfiles() ||
          (exists(/databases/$(database)/documents/organizations/$(organizationId)) == false) ||
          (resource.data.internalTeam != null && 
           resource.data.internalTeam.admins != null && 
           request.auth.uid in resource.data.internalTeam.admins) ||
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([{'organization_uid': organizationId}]))
        );
      }
      function isOrganizationAdmin() {
        return isAuthenticated() && (
          request.auth.uid == organizationId ||
          (resource.data.internalTeam != null && 
           resource.data.internalTeam.admins != null && 
           request.auth.uid in resource.data.internalTeam.admins) ||
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles != null &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([{'organization_uid': organizationId, 'roles': ['org_admin']}]))
        );
      }
      allow read: if canReadOrganization() || isSuperAdminUser();
      allow create: if request.auth.uid == organizationId || isAdmin();
      allow update: if isOrganizationAdmin() || isAdmin();
      allow delete: if isSuperAdmin() || isAdmin();
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      function isConversationParticipant() {
        return isAuthenticated() && (
          (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds) ||
          (resource.data.participants != null && request.auth.uid in resource.data.participants)
        );
      }
      function canCreateConversation() {
        return isAuthenticated() && (
          (request.resource.data.participantIds != null && request.auth.uid in request.resource.data.participantIds) ||
          (request.resource.data.participants != null && request.auth.uid in request.resource.data.participants)
        );
      }
      allow read: if isConversationParticipant();
      allow create: if canCreateConversation();
      allow update: if isConversationParticipant();
      allow delete: if false;
      
      match /messages/{messageId} {
        function isMessageParticipant() {
          return isAuthenticated() && (
            (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds) ||
            (get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants)
          );
        }
        allow read: if isMessageParticipant();
        allow create: if isMessageParticipant() && request.resource.data.senderId == request.auth.uid;
        allow update: if isMessageParticipant() && (
          resource.data.senderId == request.auth.uid ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'status'])
        );
        allow delete: if false;
      }
    }
    
    // Threads collection
    match /threads/{threadId} {
      function hasFacilityProfile() {
        return isAuthenticated() && 
               exists(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid));
      }
      function isThreadParticipant() {
        return isAuthenticated() && (
          (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds) ||
          (resource.data.participants != null && request.auth.uid in resource.data.participants)
        );
      }
      function canReadThread() {
        return isThreadParticipant() || hasFacilityProfile();
      }
      function canCreateThread() {
        return isAuthenticated() && (
          (request.resource.data.participantIds != null && request.auth.uid in request.resource.data.participantIds) ||
          (request.resource.data.participants != null && request.auth.uid in request.resource.data.participants)
        );
      }
      allow read: if canReadThread();
      allow create: if canCreateThread();
      allow update: if isThreadParticipant();
      allow delete: if isThreadParticipant();
      
      match /messages/{messageId} {
        function isThreadMessageParticipant() {
          return isAuthenticated() && (
            (get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds != null &&
            request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participantIds) ||
            (get(/databases/$(database)/documents/threads/$(threadId)).data.participants != null &&
            request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.participants)
          );
        }
        function canReadThreadMessage() {
          return isThreadMessageParticipant() || hasFacilityProfile();
        }
        allow read: if canReadThreadMessage();
        allow create: if (isThreadMessageParticipant() || hasFacilityProfile()) && request.resource.data.senderId == request.auth.uid;
        allow update: if isThreadMessageParticipant() && (
          resource.data.senderId == request.auth.uid ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'status'])
        );
        allow delete: if false;
      }
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // Positions collection
    match /positions/{positionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.postedByUserId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.postedByUserId == request.auth.uid ||
        // Allow facility admins to update position status (e.g., to 'interview')
        get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityProfileId)).data.admin.hasAny([request.auth.uid])
      );
      allow delete: if false;
      
      match /applications/{applicationId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated();
        allow delete: if false;
      }
    }
    
    // Professional Availabilities
    match /professionalAvailabilities/{availabilityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Availability collection (calendar events)
    match /availability/{availabilityId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // User Settings
    match /userSettings/{userId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Client errors
    match /client_errors/{errorId} {
      allow create: if isAuthenticated();
      allow read: if false;
    }
    
    // Audit logs
    match /audit_logs/{logId} {
      allow write: if false;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Referrals collection (for referral payouts)
    match /referrals/{referralId} {
      allow read: if isAuthenticated() && (resource.data.referrerId == request.auth.uid || resource.data.referredId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if false;
    }
    
    // Marketing spend collection
    match /marketingSpend/{spendId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if false;
    }
    
    // Operational costs collection (server costs, SMS costs, fixed costs)
    match /operationalCosts/{costId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if false;
    }

    // =========================================================================
    //  ðŸ‡¨ðŸ‡­ SWISS COMPLIANCE - Phase 1 & Phase 2 Features
    // =========================================================================

    // 1. Tutorials (Fixes "[TutorialContext] Error checking tutorial status")
    match /tutorials/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // 2. Legacy Collections (Fixes "Missing permissions" if app uses old names)
    match /workers_listings/{document=**} {
      allow read, write: if isAuthenticated();
    }
    match /jobs-listing/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // 3. Payroll Requests (Phase 1 - PayrollPlus Integration)
    match /payroll_requests/{requestId} {
      // Pharmacy can create, read their own, and update status
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        resource.data.pharmacyUid == request.auth.uid ||
        resource.data.workerUid == request.auth.uid
      );
      allow update: if isAuthenticated() && resource.data.pharmacyUid == request.auth.uid;
      allow delete: if false; // Never delete - financial records
    }

    // =========================================================================
    //  ðŸ”µ PHASE 2: Organizations & Chains
    // =========================================================================

    // Helper: Check if user is organization admin
    function isOrgAdmin(orgId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/organizations/$(orgId)) &&
             request.auth.uid in get(/databases/$(database)/documents/organizations/$(orgId)).data.admins;
    }

    // Helper: Check if user is facility admin for a specific facility
    function isFacilityAdmin(facilityId) {
      return isAuthenticated() && (
        request.auth.uid == facilityId ||
        (exists(/databases/$(database)/documents/facilityProfiles/$(facilityId)) &&
         request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(facilityId)).data.admins) ||
        (exists(/databases/$(database)/documents/facilityProfiles/$(facilityId)) &&
         request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(facilityId)).data.chainAdmins)
      );
    }

    // 4. Organizations (Pharmacy Chains/Groups)
    match /organizations/{organizationId} {
      function isOrgMember() {
        return isAuthenticated() && (
          request.auth.uid in resource.data.admins ||
          exists(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)).data.organizationId == organizationId
        );
      }
      
      allow read: if isOrgMember();
      allow create: if isAuthenticated(); // Platform creates organizations
      allow update: if isAuthenticated() && request.auth.uid in resource.data.admins;
      allow delete: if false; // Soft delete only
    }

    // 5. Staffing Requirements (The "Perfect Week" schedules)
    match /staffing_requirements/{requirementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Will verify facility admin in function
      allow update: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
      allow delete: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
    }

    // 6. Shifts (Calendar events for staffing)
    match /shifts/{shiftId} {
      function canAccessShift() {
        return isAuthenticated() && (
          isFacilityAdmin(resource.data.facilityId) ||
          resource.data.assignedUserId == request.auth.uid ||
          resource.data.userId == request.auth.uid ||
          // Organization-level access for chain admins
          (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
        );
      }
      
      allow read: if isAuthenticated(); // Workers can see open shifts
      allow create: if isAuthenticated(); // Verified in Cloud Function
      allow update: if canAccessShift();
      allow delete: if isAuthenticated() && isFacilityAdmin(resource.data.facilityId);
    }

    // 6b. Team Schedules (Monthly schedules with shifts subcollection)
    match /teamSchedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /shifts/{shiftId} {
        function isShiftFacilityMember() {
          return isAuthenticated() && resource.data.facilityId != null && (
            isFacilityAdmin(resource.data.facilityId) ||
            (exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityId)) &&
             (request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityId)).data.admins ||
              request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityId)).data.employees))
          );
        }
        
        function canAccessTeamShift() {
          return isAuthenticated() && (
            isShiftFacilityMember() ||
            resource.data.assignedUserId == request.auth.uid ||
            resource.data.userId == request.auth.uid
          );
        }
        
        allow read: if canAccessTeamShift();
        allow create: if isAuthenticated();
        allow update: if canAccessTeamShift();
        allow delete: if isAuthenticated() && (
          isFacilityAdmin(resource.data.facilityId) ||
          (resource.data.facilityId != null && 
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityId)) &&
           request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.facilityId)).data.admins)
        );
      }
    }

    // 7. Leaves (Vacation, sick leave requests)
    match /leaves/{leaveId} {
      function canAccessLeave() {
        return isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isFacilityAdmin(resource.data.facilityId) ||
          (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
        );
      }
      
      allow read: if canAccessLeave();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if canAccessLeave();
      allow delete: if false; // Never delete leave records
    }

    // 8. Cross-Facility Reports (Internal Interim tracking)
    match /cross_facility_reports/{reportId} {
      allow read: if isAuthenticated() && (
        resource.data.requestingFacilityId == request.auth.uid ||
        resource.data.providingFacilityId == request.auth.uid ||
        (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
      );
      allow create: if isAuthenticated(); // Created by Cloud Functions
      allow update, delete: if false; // Immutable financial records
    }

    // 9. Cached Document Data (15-minute auto-fill cache)
    match /cached_document_data/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 10. Extracted Data Cache (Document processing cache)
    match /extractedDataCache/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 11. Billing Information (Facility billing details)
    // Note: This is a subcollection of facilityProfiles
    match /facilityProfiles/{facilityId}/billing/{billingId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == facilityId ||
        isFacilityAdmin(facilityId)
      );
      allow write: if isAuthenticated() && isFacilityAdmin(facilityId);
    }

    // 12. Audit Professional Certification (GLN verification audit trail)
    match /auditProfessionalCertification/{auditId} {
      allow read: if isAuthenticated() && (
        resource.data.user_uid == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.user_uid == request.auth.uid;
      allow update, delete: if false;
    }

    // 13. Organization Policies (Phase 2 - Policy Library)
    match /organizationPolicies/{policyId} {
      function canAccessOrganizationPolicy() {
        return isAuthenticated() && (
          isAdmin() ||
          (resource.data.organizationId != null &&
           exists(/databases/$(database)/documents/facilityProfiles/$(resource.data.organizationId)) &&
           (request.auth.uid == resource.data.organizationId ||
            request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.organizationId)).data.admins ||
            request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(resource.data.organizationId)).data.chainAdmins)) ||
          (resource.data.organizationId != null &&
           exists(/databases/$(database)/documents/organizations/$(resource.data.organizationId)) &&
           request.auth.uid in get(/databases/$(database)/documents/organizations/$(resource.data.organizationId)).data.admins) ||
          (exists(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)).data.organizationId == resource.data.organizationId &&
           (request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)).data.admins ||
            request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(request.auth.uid)).data.chainAdmins))
        );
      }
      
      allow read: if canAccessOrganizationPolicy();
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (request.resource.data.organizationId != null &&
         exists(/databases/$(database)/documents/facilityProfiles/$(request.resource.data.organizationId)) &&
         (request.auth.uid == request.resource.data.organizationId ||
          request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(request.resource.data.organizationId)).data.admins ||
          request.auth.uid in get(/databases/$(database)/documents/facilityProfiles/$(request.resource.data.organizationId)).data.chainAdmins)) ||
        (request.resource.data.organizationId != null &&
         exists(/databases/$(database)/documents/organizations/$(request.resource.data.organizationId)) &&
         request.auth.uid in get(/databases/$(database)/documents/organizations/$(request.resource.data.organizationId)).data.admins)
      );
      allow update: if canAccessOrganizationPolicy();
      allow delete: if canAccessOrganizationPolicy();
    }

    // 14. Support Tickets (Internal tickets and anonymous reporting)
    match /supportTickets/{ticketId} {
      function isTicketOwner() {
        return isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      function canCreateTicket() {
        return isAuthenticated() && (
          request.resource.data.userId == request.auth.uid ||
          request.resource.data.userId == 'anonymous'
        );
      }
      
      allow read: if isAuthenticated() && (
        isTicketOwner() ||
        isAdmin()
      );
      allow create: if canCreateTicket();
      allow update: if isAuthenticated() && (
        isTicketOwner() ||
        isAdmin()
      );
      allow delete: if false;
    }

    // 15. Support Tickets (Legacy collection name - support_tickets)
    match /support_tickets/{ticketId} {
      function isTicketOwner() {
        return isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      function canCreateTicket() {
        return isAuthenticated() && (
          request.resource.data.userId == request.auth.uid ||
          request.resource.data.userId == 'anonymous'
        );
      }
      
      allow read: if isAuthenticated() && (
        isTicketOwner() ||
        isAdmin()
      );
      allow create: if canCreateTicket();
      allow update: if isAuthenticated() && (
        isTicketOwner() ||
        isAdmin()
      );
      allow delete: if false;
    }
  }
}