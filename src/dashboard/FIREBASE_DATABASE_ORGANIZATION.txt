# Project Implementation Documentation

## 1. Overview

This document details the architecture and implementation of the user onboarding, profile management, and workspace system for the INTERIMED platform. The platform connects healthcare professionals with facilities and provides internal HR/team management tools for facilities. It supports distinct profile types (Professional, Facility) and distinct operational contexts (Personal Workspace, Team Workspace), all driven by a configuration-based UI.

**Key System Features:**
-   **Multi-Step Onboarding Flow**: Guides new users through initial setup, personal details collection, and role selection.
-   **Dual Workspace Model**:
    * **Personal Workspace**: For individual professionals managing their marketplace presence (availabilities, contracts) and for facilities interacting with the marketplace (posting positions, finding professionals).
    * **Team Workspace**: An internal HR and scheduling tool for registered facilities to manage their staff, internal schedules, time-off requests, and handle staffing needs (including hiring from the marketplace or subletting team members).
-   **Role-Based Profiles & Permissions**: Separate profile structures and granular permissions for Professionals, Facility representatives, Team Managers, and Team Employees.
-   **Configuration-Driven UI**: Profile sections, fields, validation rules, and tab navigation are defined in JSON configuration files, allowing dynamic rendering and easier modification of profile structures per role/type.
-   **Modular Component Architecture**: React components for distinct UI sections, core functionalities, and data handling.
-   **Centralized Data Handling**: `useProfileData.js` hook manages Firestore interactions for user and core profile data.
-   **Backend Logic**: Firebase Cloud Functions are planned for complex operations, business rule enforcement, automated tasks, and secure data manipulation.

## 2. Project File Organization (Flat Map)

This map reflects the primary frontend source code structure:


frontend/src/
‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useCalendarData.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useContractsData.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useDashboardData.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useInfiniteScroll.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useMarketplaceData.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useMessagesData.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useProfileData.js         <-- Core data hook for user and profile data
‚îÇ   ‚îú‚îÄ‚îÄ layout/                       // Dashboard layout components
‚îÇ   ‚îî‚îÄ‚îÄ pages/
‚îÇ       ‚îú‚îÄ‚îÄ calendar/                 // Calendar feature page
‚îÇ       ‚îú‚îÄ‚îÄ contracts/                // Contracts feature page
‚îÇ       ‚îú‚îÄ‚îÄ marketplace/              // Marketplace feature page
‚îÇ       ‚îú‚îÄ‚îÄ messages/                 // Messaging feature page
‚îÇ       ‚îú‚îÄ‚îÄ onboarding/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ OnboardingFlow.js     <-- Manages initial user setup & role selection
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ onboardingFlow.module.css <-- Styles for OnboardingFlow.js
‚îÇ       ‚îú‚îÄ‚îÄ personalDashboard/        // User's main dashboard page
‚îÇ       ‚îî‚îÄ‚îÄ profile/                  <-- Main profile editing (Personal & initial Facility setup)
‚îÇ           ‚îú‚îÄ‚îÄ facilities/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FacilityDetails.js  <-- Renders facility-specific profile sections
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ configs/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ facility-pharmacy.json  <-- Example JSON config for a "pharmacy" facility type
‚îÇ           ‚îú‚îÄ‚îÄ professionals/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PersonalDetails.js
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BillingInformation.js
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DocumentUploads.js
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ configs/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ professional-doctor.json <-- Example JSON config for a "doctor"
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ professionalBackgroundUtils.js <-- Helpers for ProfessionalBackground.js
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ProfessionalBackground.js
‚îÇ           ‚îú‚îÄ‚îÄ components/                 // Shared components used by Profile.js orchestrator
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ProfileHeader.js        <-- Renders tab navigation for profile sections
‚îÇ           ‚îú‚îÄ‚îÄ Profile.js                  <-- Orchestrates profile display/editing
‚îÇ           ‚îî‚îÄ‚îÄ profile.module.css          <-- Styles for Profile.js & ProfileHeader
‚îÇ       ‚îî‚îÄ‚îÄ teamWorkspace/                <-- For internal facility team management
‚îÇ           ‚îú‚îÄ‚îÄ components/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ TeamMemberManagement.js
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ ScheduleView.js
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ TimeOffRequestForm.js
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ           ‚îú‚îÄ‚îÄ TeamWorkspace.js            <-- Main orchestrator for a facility's team view
‚îÇ           ‚îî‚îÄ‚îÄ teamWorkspace.module.css
‚îú‚îÄ‚îÄ contexts/                             // React Context API
‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.js
‚îÇ   ‚îî‚îÄ‚îÄ NotificationContext.js
‚îú‚îÄ‚îÄ components/                           // Global, reusable UI components
‚îÇ   ‚îî‚îÄ‚îÄ ... (Buttons, Inputs, Modals etc.)
‚îú‚îÄ‚îÄ configs/                              // Centralized JSON configurations (alternative if not nested)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ firebase.js                     // Firebase initialization
‚îú‚îÄ‚îÄ locales/                              // i18n translation files
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ styles/                               // Global styles or shared CSS modules
‚îî‚îÄ‚îÄ profileUnified.module.css       <-- Shared styles for profile section components


## 3. Onboarding Flow (`OnboardingFlow.js`)

**Location**: `/src/pages/onboarding/OnboardingFlow.js`
**Purpose**: Handles initial user setup.
**Steps**:
1.  Welcome & Verification (Placeholders for phone/ID).
2.  Personal Details Collection (using `PersonalDetails.js` with a minimal config).
3.  Role Choice (Professional or Facility representative).
4.  Finalization: Updates user role/type in Firestore via `useProfileData`, initializes the respective profile structure, saves collected personal details, and redirects to `/dashboard/profile`.

## 4. Workspace Concepts & Role-Based Access

### 4.1. Personal Workspace
-   **For Professionals**: Context for individual professionals to manage their public `professionalProfile` (skills, documents, marketplace `availabilities`).
-   **For Facility Admins**: Context for facility representatives to interact with the marketplace (post `positions`, search professionals, manage `contracts`).
-   **Access Control**: User must have `professional` role OR be listed as admin/employee in a `facilityProfile`.

### 4.2. Team Workspace (`TeamWorkspace.js`)
**Location (Conceptual):** `/src/pages/dashboard/teamWorkspace/TeamWorkspace.js`
-   Internal HR/scheduling tool for a specific facility, accessed by its `teamMembers`.
-   **Employees**: View team schedules, submit `timeOffRequests`.
-   **Managers/Admins**: Manage `teamMembers`, approve/reject `timeOffRequests`, create/publish `teamSchedules`, handle staffing gaps by posting `positions` to the marketplace or initiating "subletting" of team members.
-   **Access Control**: User must be listed in `facilityProfiles/{facilityId}/admin` OR `facilityProfiles/{facilityId}/employees`.

### 4.3. Workspace Selection Logic
-   **Both Professional & Facility Access**: Display workspace selector with both options.
-   **Professional Only**: Display only Personal Workspace (no selector needed).
-   **Facility Only**: Display only Team Workspace (no selector needed).
-   **No Access**: During account creation, don't display workspace selector.

## 5. Profile Management System (`Profile.js`)

**Location**: `/src/pages/dashboard/profile/Profile.js`
Orchestrates the detailed completion and editing of `ProfessionalProfile` or `FacilityProfile` documents after onboarding. It loads role/type-specific JSON configurations to dynamically render tabs (via `ProfileHeader.js`) and section components (`PersonalDetails.js`, `ProfessionalBackground.js`, `FacilityDetails.js`, etc.).

## 6. Data Management Hook (`useProfileData.js`)

**Location**: `/src/dashboard/hooks/useProfileData.js`
Centralizes Firestore interactions for fetching, updating, and initializing user and profile data, handling the distinction between `users`, `professionalProfiles`, and `facilityProfiles`.

## 7. Firestore Data Structure

### 7.1. `users` Collection
**Purpose**: Core user identity, authentication linkage, role(s), and pointers to specific profiles.
**Document ID**: `userId` (Matches Firebase Authentication UID)
**Key Fields**:
* `uid`: String (Firebase Auth UID)
* `email`: String (Login email)
* `firstName`: String (User's own first name)
* `lastName`: String (User's own last name)
* `photoURL`: String (URL to user's avatar)
* `roles`: Array of Strings (e.g., `["professional"]`, `["facility_admin_facilityId1"]`, `["facility_employee_facilityId1"]`). Can hold multiple roles.
* `professionalProfileId`: String (Optional, ID of their document in `professionalProfiles`)
* `facilityMemberships`: Array of Objects (Client-side helper, e.g., `{ facilityProfileId: "facility123", facilityName: "City Clinic", role: "admin" }`)
* `onboardingStatus`: String (e.g., "completed", "pending_verification")
* `notificationPreferences`: Map
* `consents`: Map (`{ tosVersion: '1.1', acceptedAt: Timestamp }`)
* `isActive`: Boolean (Platform-level account status)
* `fcmTokens`: Array of Strings (For push notifications)
* `createdAt`: Timestamp
* `updatedAt`: Timestamp
* `lastLoginAt`: Timestamp

### 7.2. `professionalProfiles` Collection
**Purpose**: Detailed information for users acting as healthcare professionals.
**Document ID**: `professionalProfileId` (Typically matches `userId`)
**Key Fields**:
* `userId`: String (Back-reference to `users`)
* `profileType`: String (Specific profession, e.g., "doctor", "pharmacist". Drives JSON config).
* **`identity` (Map)**:
    * `legalFirstName`: String
    * `legalLastName`: String
    * `dateOfBirth`: Timestamp or ISO String
    * `nationality`: String
    * `ahvNumber`: String (Swiss Social Security Number) - *High sensitivity*
* **`contact` (Map)**:
    * `primaryPhone`: String
    * `primaryEmail`: String
    * `residentialAddress`: Map (`{ street, number, postalCode, city, canton, country: 'CH' }`)
* **`employmentEligibility` (Map)**:
    * `workPermit`: Map (`{ type, permitNumber, expiryDate, issuingCanton }`)
* **`profileDisplay` (Map)**:
    * `displayName`: String (Optional)
    * `profilePictureUrl`: String (Optional, can be distinct from `users.photoURL`)
    * `languagesSpoken`: Array of Maps (`[{ language, level }]`)
    * `bioOrSummary`: String
    * `experienceYears`: Number
* **`professionalDetails` (Map)**: (Structure driven by `professional-<type>.json` config)
    * `mainProfession`: String (Can be more specific than `profileType`)
    * `specializations`: Array of Strings
    * `skills`: Array of Strings
    * `softwareProficiency`: Array of Maps (`[{ name, level }]`)
    * `qualifications`: Array of Maps (Licenses, Diplomas, Certs as per config's `itemSchema`)
    * `workExperience`: Array of Maps (Employment history as per config's `itemSchema`)
    * `education`: Array of Maps (Educational background as per config's `itemSchema`)
* **`payrollData` (Map)**: *Highest Sensitivity - Strict Access Control*
    * `civilStatus`: String
    * `numberOfChildren`: Number
    * `withholdingTaxInfo`: Map (`{ isSubject, taxCanton, rateGroup }`)
    * `religion`: String (For church tax, optional)
* **`banking` (Map)**: For receiving salary. *Highest Sensitivity*
    * `iban`: String
    * `bankName`: String
    * `accountHolderName`: String
* **`platformSettings` (Map)**: User's preferences for using the platform's marketplace features.
    * `detailedAvailability`: Map (`{ availabilityType, minHoursPerWeek, preferredWorkdays, noticePeriodDays, earliestStartDate, notes }`)
* **`verification` (Map)**: Platform verification status of different profile aspects.
    * `identityStatus`, `qualificationsStatus`, `workEligibilityStatus`, `overallVerificationStatus`: String
    * `verificationDocuments`: Array of Maps (`{ documentId, type, fileName, storageUrl, status }`)
* `isActiveOnMarketplace`: Boolean
* `createdAt`: Timestamp
* `updatedAt`: Timestamp

### 7.3. `facilityProfiles` Collection
**Purpose**: Detailed information for facility entities. This document is central to the "Team Workspace".
**Document ID**: `facilityProfileId` (Unique ID for the facility)
**Key Fields**:
* `facilityName`: String (Public display name, may differ from legal)
* `profileType`: String (e.g., "pharmacy", "clinic". Drives JSON config).
* **`identityLegal` (Map)**: Core Legal & Business Identification.
    * `legalCompanyName`: String (As per Commercial Register)
    * `uidNumber`: String (Swiss Enterprise ID, CHE-XXX.XXX.XXX)
    * `vatNumber`: String (Optional)
    * `companyType`: String (e.g., "AG", "GmbH")
    * `cantonOfRegistration`: String
    * `commercialRegisterNumber`: String (Optional)
* **`contactPoints` (Map)**: Official Addresses & Communication.
    * `registeredAddress`: Map (`{ street, number, postalCode, city, canton, country: 'CH' }`)
    * `operatingAddress`: Map (Optional, if different)
    * `generalPhone`: String
    * `generalEmail`: String
    * `websiteUrl`: String
* **`profilePublic` (Map)**: Public-Facing Information.
    * `logoUrl`: String
    * `industrySector`: String
    * `companySizeRange`: String
    * `descriptionPublic`: String (About the facility)
* **`operationalEnvironment` (Map)**: Internal Workings & Tools for the Team Workspace.
    * `primarySoftwareUsed`: Array of Maps (`[{ category, name }]`)
    * `collectiveLaborAgreementInfo`: Map (`{ applies, agreementName }`)
    * `standardWorkWeekHours`: Number
    * `workingHoursModel`: String
    * `remoteWorkPolicy`: String
* **`recruitmentAndContracts` (Map)**: Facility's hiring processes & standard contractual elements.
    * `hiringContactPerson`: Map (`{ name, email, phone }`)
    * `typicalOnboardingDocumentsRequired`: Array of Strings
* **`payrollAndComplianceInfo` (Map)**: Employer payroll obligations setup. *High sensitivity.*
    * `compensationFundInfo`: Map (`{ canton, fundName, employerAffiliationNumber }`)
    * `accidentInsuranceProvider`: Map (`{ providerName, policyNumber }`)
    * `occupationalPensionProvider`: Map (`{ providerName, contractNumber }`)
* **`platformAccountAndBilling` (Map)**: Facility's relationship with your platform.
    * `platformBillingContact`: Map
    * `platformSubscriptionPlan`: String
* **`verification` (Map)**: Platform verification status of the facility.
    * `overallStatus`: String
    * `identityCheck`: Map (`{ method, status, documentRefs }`)
    * `verificationDocumentsProvided`: Array of Maps (`{ documentId, type, fileName, storageUrl, status }`)
* **`admin` (Array of Strings)**: User IDs with administrative access to this facility.
    * Contains Firebase Auth UIDs of users who can manage this facility.
* **`employees` (Array of Strings)**: User IDs of team members/employees.
    * Contains Firebase Auth UIDs of users who are employees of this facility.
* **`operationalSettings` (Map)**: Settings specific to the Team Workspace functionality for this facility.
    * `standardOpeningHours`: Object (e.g., `{ mon: "08:00-18:00", tue: "08:00-18:00", ... }`)
    * `minStaffPerShiftType`: Object (e.g., `{ pharmacist_day: 1, technician_day: 2 }`) - Defines minimum staffing levels for different roles/times.
    * `timeOffApprovalWorkflow`: String (e.g., "manager_approval_required", "auto_approve_if_coverage")
* `createdAt`: Timestamp
* `updatedAt`: Timestamp

### 7.4. `contracts` Collection
**Purpose**: Stores agreements between a facility and a professional, typically for marketplace engagements or potentially for "subletting" arrangements.
**Document ID**: `contractId` (Unique ID)
**Key Fields**:
* **`parties` (Map)**:
    * `employer`: Map (`{ profileId (facilityProfileId), legalCompanyName, address }`)
    * `professional`: Map (`{ profileId (professionalProfileId), legalFirstName, legalLastName, address, ahvNumber }`)
* **`terms` (Map)**: Core contractual details.
    * `jobTitle`, `startDate`, `endDate` (optional), `contractType` ("permanent", "fixed_term", "temporary_marketplace"), `workLocation`, `workPercentage`, `salary` (`{ grossAmount, currency, period, includesThirteenth }`), `annualVacationDays`, `probationPeriod`, `noticePeriodAfterProbation`.
* **`statusLifecycle` (Map)**:
    * `currentStatus`: String (e.g., "draft", "pending_professional_approval", "active", "completed", "terminated")
    * `validation`: Map (Approval tracking for both parties)
    * `timestamps`: Map (`createdAt`, `activatedAt`, `terminatedAt`)
* **`platformMeta` (Map)**:
    * `platformFee`: Map (`{ status, amount }`)
    * `generatedContractUrl`: String
    * `createdByUserId`: String
* `originType`: String (e.g., "marketplace_position", "marketplace_availability", "team_sublet") - *NEW: To distinguish contract origins*
* `originPositionId`: String (Optional, if from a marketplace `position`)
* `originAvailabilityId`: String (Optional, if from a professional's `availability`)
* `originTeamShiftId`: String (Optional, if related to a sublet shift from `teamSchedules`)
* `lendingFacilityProfileId`: String (Optional, if this is a sublet contract, this is the original employer)
* `associatedProfileType`: String ("professional" or "facility") - Indicates which profile type this contract is primarily associated with
* `associatedProfileId`: String (professionalProfileId or facilityProfileId) - The primary profile this contract belongs to

### 7.5. `professionalAvailabilities` Collection (Marketplace)
**Purpose**: Professionals list their availability for marketplace engagements.
**Document ID**: `availabilityId`
**Key Fields**:
* `professionalProfileId`: String
* `userId`: String
* `startTime`: Timestamp
* `endTime`: Timestamp
* `status`: String ("available", "booked", "unavailable_internal") - *`unavailable_internal` can be set by approved `timeOffRequests`*.
* `jobTypes`: Array of Strings
* `locationPreference`: Map
* *(Other fields as previously defined)*

### 7.6. `positions` Collection (Marketplace - formerly `employerNeeds`)
**Purpose**: Facilities post their open staffing needs to the marketplace.
**Document ID**: `positionId`
**Key Fields**:
* `facilityProfileId`: String (Posting facility)
* `postedByUserId`: String
* `status`: String ("open", "filled", "cancelled")
* `jobTitle`: String
* `jobType`: String (Professional type needed)
* `startTime`: Timestamp
* `endTime`: Timestamp
* `location`: Map
* `description`: String
* `compensation`: Map
* **`applications` (Subcollection)**:
    * `/{applicationId}` (or `professionalProfileId`)
        * `professionalProfileId`, `userId`, `applicationTime`, `status` ("submitted", "viewed", "accepted_for_contract")

### 7.7. `timeOffRequests` Collection (NEW - Internal to Team Workspace)
**Purpose**: Employees within a facility's team request time off.
**Document ID**: `timeOffRequestId`
**Key Fields**:
* `facilityProfileId`: String (The facility/team this request belongs to)
* `userId`: String (The employee requesting time off)
* `professionalProfileId`: String (Optional, for context if they also have a public profile)
* `startTime`: Timestamp
* `endTime`: Timestamp
* `type`: String (e.g., "vacation", "sick_leave_paid", "personal_appointment")
* `reason`: String (Optional)
* `status`: String ("pending", "approved", "rejected", "cancelled_by_employee")
* `managerNotes`: String (Optional)
* `approvedByUserId`: String (Optional, manager who actioned)
* `actionTimestamp`: Timestamp (Optional)
* `createdAt`: Timestamp
* `updatedAt`: Timestamp

### 7.8. `teamSchedules` Collection (NEW - Internal to Team Workspace)
**Purpose**: Stores the published work schedules for a facility's team.
**Document ID**: `scheduleId` (e.g., `facilityProfileId_YYYY-MM` or auto-ID)
**Key Fields**:
* `facilityProfileId`: String
* `periodStartDate`: Timestamp
* `periodEndDate`: Timestamp
* `status`: String ("draft", "published_to_team", "locked")
* `version`: Number (For tracking schedule changes)
* `notes`: String (Overall notes for this schedule period)
* `createdByUserId`: String (Manager who created/published)
* `publishedAt`: Timestamp (Optional)
* `createdAt`: Timestamp
* `updatedAt`: Timestamp
* **`shifts` (Subcollection)**:
    * `/{shiftId}`
        * `userId`: String (Assigned team member from `facilityProfiles/{facilityId}/admin` or `employees`)
        * `startTime`: Timestamp
        * `endTime`: Timestamp
        * `roleOrTask`: String (e.g., "Pharmacist On-Duty", "Dispensing Shift")
        * `notes`: String (Optional, shift-specific notes)
        * `isSublettable`: Boolean (Manager marks if this shift/employee can be offered to other facilities)
        * `subletStatus`: String (e.g., "none", "available_for_sublet", "pending_sublet_acceptance", "sublet_confirmed")
        * `subletToFacilityId`: String (Optional, `facilityProfileId` of the facility taking the sublet shift)
        * `subletContractId`: String (Optional, link to a `contracts` document for the sublet arrangement)

### 7.9. `conversations` and `messages` Collections (Updated for Scalability & Contract Linkage)
**Purpose**: To facilitate communication between users, primarily between a facility representative and a professional in the context of a signed contract. Can be extended for other communication needs.

* **Collection**: `conversations`
    * **Document ID**: `conversationId` (Auto-generated by Firestore)
    * **Key Fields**:
        * `participantIds`: Array of Strings (Contains `userId`s of all participants in the conversation. E.g., `[professionalUserId, facilityRepresentativeUserId]`). *Indexed for array-contains queries.*
        * `participantInfo`: Array of Objects (Denormalized data for quick display in conversation lists).
            * Example: `[{ userId: "user123", displayName: "Dr. Jane Doe", photoURL: "url...", roleInConversation: "professional" }, { userId: "user456", displayName: "John Smith (City Clinic)", photoURL: "url...", roleInConversation: "facility_representative" }]`
        * `facilityProfileId`: String (ID of the facility involved in this conversation. Links to `facilityProfiles`). *Indexed.*
        * `professionalProfileId`: String (ID of the professional involved. Links to `professionalProfiles`). *Indexed.*
        * `contractId`: String (**Crucial**: Links this conversation to a specific signed contract from the `contracts` collection). *Indexed.*
        * `lastMessage`: Map (Denormalized snippet of the latest message for UI previews).
            * `text`: String (Truncated message text).
            * `senderId`: String (`userId` of the last message sender).
            * `timestamp`: Timestamp.
        * `lastMessageTimestamp`: Timestamp (Used for ordering conversation lists). *Indexed (descending).*
        * `unreadCounts`: Map (Tracks unread messages per participant).
            * Example: `{ "userId123": 0, "user456": 2 }`. Updated via Cloud Functions.
        * `isArchivedBy`: Array of Strings (Contains `userId`s of participants who have archived this conversation from their view).
        * `typingIndicator`: Map (For real-time typing indicators).
            * Example: `{ "userId123": true, "user456": false }`.
        * `createdAt`: Timestamp (When the conversation was initiated).
        * `updatedAt`: Timestamp (Typically same as `lastMessageTimestamp`).

* **Subcollection**: `conversations/{conversationId}/messages`
    * **Document ID**: `messageId` (Auto-generated by Firestore, allows default chronological ordering).
    * **Key Fields**:
        * `senderId`: String (`userId` of the message sender).
        * `text`: String (Actual message content).
        * `imageUrl`: String (Optional, URL to an image if the message is an image).
        * `fileUrl`: String (Optional, URL to a file attachment).
        * `fileName`: String (Optional, display name for the file).
        * `fileType`: String (Optional, MIME type of the file).
        * `timestamp`: Timestamp (Server timestamp preferred for message ordering).
        * `status`: String (Optional, for delivery/read receipts, e.g., "sent", "delivered", "read", "failed").
        * `reactions`: Array of Objects (Optional, for message reactions, e.g., `[{ userId: "user123", emoji: "üëç" }]`).

**Workflow for Conversation Creation (linked to Contracts):**
1.  A `contract` document reaches a "signed" or "active" status.
2.  A **Firebase Cloud Function** (triggered by this status change in the `contracts` collection):
    * Identifies the `professionalUserId` and the relevant `facilityRepresentativeUserId(s)` associated with the contract.
    * Creates a new document in the `conversations` collection.
    * Populates `participantIds`, `participantInfo`, `facilityProfileId`, `professionalProfileId`, and the crucial `contractId`.
    * Optionally, sends an initial system message into the `messages` subcollection (e.g., "Your contract [Contract Name/ID] is now active. You can communicate regarding this contract here.").
    * Sends notifications (e.g., FCM push, email) to participants about the new conversation channel.

**Scalability Notes:**
-   Using a subcollection for `messages` is highly scalable, as each conversation's messages are stored independently.
-   Querying for a user's conversations can be done efficiently using `where("participantIds", "array-contains", currentUser.uid)` and ordering by `lastMessageTimestamp`.
-   Denormalizing `lastMessage` and `unreadCounts` on the parent `conversation` document allows for efficient rendering of conversation list UIs without needing to query the `messages` subcollection for each conversation.

## 8. Backend Logic (Conceptual - Firebase Cloud Functions)
*(Updated to reflect messaging changes)*
Cloud Functions will be essential for:
* User creation/initialization.
* Team Workspace: Processing `timeOffRequests`, syncing with marketplace `professionalAvailabilities`, "smart" scheduling (future), team member management.
* Marketplace & Contracts: Application management, contract lifecycle (initiation, acceptance, status changes, notifications). **Triggering conversation creation upon contract signing.**
* Subletting workflows.
* **Messaging**:
    * Updating `lastMessage` and `unreadCounts` on parent `conversation` documents (Firestore Trigger on `messages` subcollection).
    * Sending FCM push notifications for new messages.
    * Managing read receipts by updating `unreadCounts` (HTTPS Callable function called by client when messages are read).
* Notifications (FCM) for other various events.
* Scheduled tasks.

## 8. Session-Based Authorization System

### 8.1. Workspace Access Tokens
**Purpose**: Create time-limited session tokens for accessing specific workspace resources.
**Implementation**: 
- When user accesses Personal or Team workspace, validate their permissions and create a 1-hour session token.
- Store in secure HTTP-only cookies with workspace-specific scope.
- Validate on each protected resource access.

### 8.2. Authorization Flow
1. **User Authentication**: Firebase Auth validates user identity.
2. **Role Verification**: Check user's roles array and facility memberships.
3. **Workspace Selection**: User selects workspace (if multiple available).
4. **Token Generation**: Create workspace-specific session token with 1-hour expiry.
5. **Resource Access**: Validate token on each protected resource request.

### 8.3. Permission Levels
- **Professional Workspace**: User must have `professional` role OR be in any facility's admin/employees.
- **Team Workspace**: User must be in specific facility's `admin` or `employees` array.
- **Cross-Workspace**: Users with both professional and facility access can switch between workspaces.

## 9. Backend Logic (Conceptual - Firebase Cloud Functions)

With the introduction of Team Workspaces, the need for Cloud Functions becomes even more critical for:
-   **Team Management**: Adding/removing team members, role updates within a team.
-   **Time-Off & Availability Sync**: A Firestore Trigger on `timeOffRequests` (when status becomes "approved") *must* update the corresponding professional's public `professionalAvailabilities` to mark them as unavailable, preventing marketplace conflicts.
-   **Scheduling Logic**:
    * Validating manually created schedules against `timeOffRequests` and `operationalSettings`.
    * The "Smart Matching" algorithm for auto-generating `teamSchedules` (future development).
-   **Subletting Workflow**:
    * Functions to list a `teamSchedules/{scheduleId}/shifts/{shiftId}` as available for subletting (perhaps creating a special entry in `positions` or a new "loanedShifts" collection).
    * Handling acceptance of a sublet offer and creating the necessary `contracts` between facilities or between professional and borrowing facility.
-   **Session Token Management**: Generate and validate workspace-specific session tokens.
-   **Authorization Middleware**: Validate user permissions for workspace access.
-   **Notifications**: For schedule publications, time-off request updates, new shift assignments, sublet opportunities/confirmations, contract status changes, new marketplace positions, applications, and messages.
-   **Data Integrity & Aggregation**: Maintaining consistency (e.g., if an employee leaves a team, update relevant schedules or mark shifts as unassigned).

## 10. Styling

-   **CSS Modules**: Primary approach.
    -   `profile.module.css`: Styles `Profile.js` orchestrator and `ProfileHeader.js`.
    -   `profileUnified.module.css`: Shared styles for elements *within* profile section components (`PersonalDetails.js`, `FacilityDetails.js`, etc.).
    -   `onboardingFlow.module.css`: For the `OnboardingFlow.js` component.
    -   `teamWorkspace.module.css` (NEW): For the `TeamWorkspace.js` orchestrator and its specific internal components (schedule views, team member lists, etc.).
-   **CSS Variables**: Global for theming.

## 11. Key Challenges & Considerations (with Team Workspace)

-   **Complexity of "Smart Scheduling"**: This is a significant feature. Initial versions should focus on robust manual scheduling and clear display of team member availabilities/time-off.
-   **Synchronization Logic (Internal vs. Marketplace)**: The Cloud Function logic to keep an employee's internal team schedule/time-off consistent with their public marketplace availability (`professionalAvailabilities`) must be very reliable.
-   **Subletting Mechanics & Contracts**: The legal and financial model for subletting needs careful definition, which will drive the contract structure and workflow.
-   **Granular Permissions within Teams**: The `admin` and `employees` arrays in `facilityProfiles` will need to be used effectively in Firestore Security Rules and Cloud Functions to control actions.
-   **User Experience for Multiple Roles/Workspaces**: A user might be a professional on the marketplace, an employee in Facility A, and a manager in Facility B. The UI must provide a clear and seamless way to switch between these contexts and view relevant information.
-   **Session Security**: Workspace session tokens must be properly secured and validated to prevent unauthorized access.
-   **Audit Trails**: For actions within the Team Workspace (schedule changes, time-off approvals, sublet agreements), audit logs will be important.

This comprehensive documentation now reflects the dual-workspace model, integrating the detailed Firestore structures and outlining the expanded functionalities with role-based access control and session management.
